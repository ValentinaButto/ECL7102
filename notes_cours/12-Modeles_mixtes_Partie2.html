<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Modèles linéaires mixtes, partie 2</title>

<script src="libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="libs/bootstrap-3.3.5/css/spacelab.min.css" rel="stylesheet" />
<script src="libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="libs/navigation-1.1/tabsets.js"></script>
<link href="libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>



<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Modèles linéaires mixtes, partie 2</h1>
<h4 class="date"><br/>22 novembre 2021</h4>

</div>


<div id="rappel" class="section level1">
<h1>Rappel</h1>
<p>Lors du dernier cours, nous avons vu différentes façons de traiter des données groupées dans le contexte d’une régression linéaire “classique”: ignorer les groupes, estimer séparément des effets pour chaque groupe, ou tenir compte indirectement des groupes à partir de prédicteurs mesurés au niveau de ces groupes.</p>
<ul>
<li><p>D’une part, ignorer la structure groupée des données peut mener à une surestimation de la précision des inférences, car les tests de significativité et intervalles de confiance de la régression linéaire sont basés sur la supposition que les résidus sont tous indépendants; ce n’est pas le cas lorsque les résidus d’un même groupe sont corrélés.</p></li>
<li><p>D’autre part, estimer des effets fixes pour chaque groupe peut mener à une surestimation des différences entre groupes, surtout lorsqu’on a peu d’observations par groupe; dans ce cas, une bonne partie des différences observées est due au hasard de l’échantillonnage.</p></li>
</ul>
<p>Cette discussion nous a amené à considérer les <em>modèles linéaires mixtes</em> pour traiter ce type de données.</p>
<ul>
<li><p>Contrairement à la régression linéaire qui n’inclut qu’un terme aléatoire (les résidus au niveau des observations individuelles), les modèles mixtes incluent la variation aléatoire partagée par les observations d’un même groupe.</p></li>
<li><p>Les modèles mixtes produisent aussi des estimés des coefficients de la régression pour chaque groupe, mais en supposant une distribution normale de ces coefficients centrée sur la moyenne des groupes. Comparé aux effets fixes de groupe, ces coefficients sont “contractés” vers la moyenne générale. Cela permet d’obtenir des estimés plus fiables même avec peu d’observations par groupe.</p></li>
</ul>
</div>
<div id="objectifs" class="section level1">
<h1>Objectifs</h1>
<ul>
<li><p>Comprendre comment les modèles mixtes traitent le cas de groupes non-équilibrés.</p></li>
<li><p>Faire des prédictions à partir d’un modèle linéaire mixte.</p></li>
<li><p>Créer des modèles avec l’effet aléatoire de plusieurs variables et l’effet aléatoire d’une variable sur plus d’un coefficient.</p></li>
<li><p>Appliquer la sélection de modèles avec l’AIC aux modèles mixtes.</p></li>
</ul>
</div>
<div id="modèles-mixtes-pour-groupes-non-équilibrés" class="section level1">
<h1>Modèles mixtes pour groupes non-équilibrés</h1>
<p>Dans les exemples vus lors du cours et du laboratoire de la semaine dernière, le nombre d’observations était équilibré entre les groupes. Les modèles mixtes ont aussi des propriétés intéressantes pour les cas où les groupes ne contiennent pas le même nombre d’observations, comme nous le verrons dans le prochain exemple.</p>
<div id="exemple-concentration-de-radon-dans-des-maisons-du-minnesota" class="section level2">
<h2>Exemple: Concentration de radon dans des maisons du Minnesota</h2>
<p>Le jeu de données <a href="../donnees/radon.csv">radon.csv</a>, tiré du manuel de Gelman et Hill, contient des mesures de concentration de radon (<code>log_radon</code>, échelle logarithmique) prises dans 919 maisons réparties dans 85 comtés (<code>county</code>) de l’état américain du Minnesota. Le nombre de maisons par comté varie de 1 à 116. Ce jeu de données inclut un prédicteur au niveau de la maison, soit l’étage où la mesure a été prise (<code>floor</code>, avec 0 = sous-sol et 1 = rez-de-chaussée) et un prédicteur au niveau du comté, soit la concentration d’uranium du sol (<code>log_uranium</code>, échelle logarithmique).</p>
<pre class="r"><code>radon &lt;- read.csv(&quot;../donnees/radon.csv&quot;)
head(radon)</code></pre>
<pre><code>##   county floor log_uranium log_radon
## 1 AITKIN     1  -0.6890476 0.7884574
## 2 AITKIN     0  -0.6890476 0.7884574
## 3 AITKIN     0  -0.6890476 1.0647107
## 4 AITKIN     0  -0.6890476 0.0000000
## 5  ANOKA     0  -0.8473129 1.1314021
## 6  ANOKA     0  -0.8473129 0.9162907</code></pre>
<p>Nous estimons les paramètres d’un modèle mixte avec des effets fixes de l’étage et de la concentration d’uranium, ainsi qu’une variation aléatoire de l’ordonnée à l’origine par comté.</p>
<pre class="r"><code>library(lme4)
mm_radon &lt;- lmer(log_radon ~ floor + log_uranium + (1 | county), radon)
summary(mm_radon)</code></pre>
<pre><code>## Linear mixed model fit by REML [&#39;lmerMod&#39;]
## Formula: log_radon ~ floor + log_uranium + (1 | county)
##    Data: radon
## 
## REML criterion at convergence: 2134.2
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -4.9673 -0.6117  0.0274  0.6555  3.3848 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev.
##  county   (Intercept) 0.02446  0.1564  
##  Residual             0.57523  0.7584  
## Number of obs: 919, groups:  county, 85
## 
## Fixed effects:
##             Estimate Std. Error t value
## (Intercept)  1.46576    0.03794  38.633
## floor       -0.66824    0.06880  -9.713
## log_uranium  0.72027    0.09176   7.849
## 
## Correlation of Fixed Effects:
##             (Intr) floor 
## floor       -0.357       
## log_uranium  0.145 -0.009</code></pre>
<p>Comment peut-on interpréter les effets fixes dans ce modèle?</p>
<ul>
<li><code>(Intercept)</code> est la moyenne de <code>log_radon</code> si <code>floor</code> = 0 (dans un sous-sol) et <code>log_uranium</code> = 0.</li>
<li><code>floor</code> est la différence de <code>log_radon</code> si <code>floor</code> augmente de 1 (donc rez-de-chaussée comparé au sous-sol).</li>
<li><code>log_uranium</code> est l’effet d’une augmentation d’une unité de <code>log_uranium</code> sur <code>log_radon</code>. Dans le cas particulier où les deux variables sont sur une échelle logarithmique, on peut interpréter ce coefficient comme un effet multiplicatif: une augmentation de 1% de la concentration d’uranium du sol augmente la concentration de radon dans les maisons de 0.72%.</li>
</ul>
<p>Utilisons maintenant le modèle pour prédire <code>log_radon</code> pour un sous-sol dans chacun des comtés. Pour commencer, nous extrayons le nom du comté, la concentration d’uranium et le nombre de maisons par comté (cette dernière valeur sera utilisée plus loin).</p>
<pre class="r"><code>comtes &lt;- group_by(radon, county, log_uranium) %&gt;%
    summarize(n = n()) %&gt;%
    ungroup()</code></pre>
<pre><code>## `summarise()` has grouped output by &#39;county&#39;. You can override using the `.groups` argument.</code></pre>
<p>Voici le graphique des prédictions:</p>
<pre class="r"><code>comtes$floor &lt;- 0 # sous-sol
comtes$mm_pred &lt;- predict(mm_radon, comtes)

ggplot(comtes, aes(x = log_uranium, y = mm_pred)) +
    geom_point()</code></pre>
<p><img src="12-Modeles_mixtes_Partie2_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
<p>Ces prédictions dévient de la tendance linéaire moyenne en fonction des ordonnées à l’origine estimées pour chaque comté (effets aléatoires).</p>
<p>Comparons maintenant ces prédictions à ceux de deux régressions linéaires classiques, avec aucun effet de comté (mais avec l’effet de l’uranium) ou un effet fixe par comté.</p>
<pre class="r"><code>lm_radon1 &lt;- lm(log_radon ~ floor + log_uranium, radon)
lm_radon2 &lt;- lm(log_radon ~ floor + county, radon)

comtes &lt;- mutate(comtes, pred1 = predict(lm_radon1, comtes), 
                 pred2 = predict(lm_radon2, comtes))

ggplot(comtes, aes(x = log_uranium)) +
    labs(y = &quot;log_radon&quot;) +
    geom_line(aes(y = pred1)) +
    geom_point(aes(y = pred2), shape = 1) +
    geom_point(aes(y = mm_pred))</code></pre>
<p><img src="12-Modeles_mixtes_Partie2_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<p>La ligne représente la prédiction sans effet de comté, les points pleins indiquent les effets de comté du modèle mixte et les points vides indiquent les effets fixes par comté. Les prédictions du modèle mixte se rapprochent plus de la tendance moyenne, démontrant la contraction des coefficients pour le modèle mixte.</p>
<p>Regardons maintenant l’effet de la taille de l’échantillon <span class="math inline">\(n\)</span> dans chaque comté. Aux fins de clarté, les deux prédictions d’un même comté sont reliées par une ligne pointillée.</p>
<pre class="r"><code>ggplot(comtes, aes(x = log_uranium)) +
    labs(y = &quot;log_radon&quot;) +
    geom_line(aes(y = pred1)) +
    geom_point(aes(y = pred2, size = n), shape = 1) +
    geom_point(aes(y = mm_pred, size = n)) +
    geom_segment(aes(xend = log_uranium, y = mm_pred, yend = pred2),
                 linetype = &quot;dotted&quot;)</code></pre>
<p><img src="12-Modeles_mixtes_Partie2_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
<p>Ce résultat montre que plus l’échantillon est faible dans un comté, plus l’effet de contraction est important. Autrement dit, moins il y a de points dans un comté, plus la déviation observée entre ce comté et la tendance globale risque d’être due au hasard de l’échantillonnage et plus le modèle mixte doit “corriger” cette valeur en la ramenant près de la tendance générale.</p>
</div>
</div>
<div id="prédictions-à-partir-dun-modèle-mixte" class="section level1">
<h1>Prédictions à partir d’un modèle mixte</h1>
<p>Au dernier cours, nous avons vu la représentation suivante pour un modèle mixte avec des prédicteurs mesurés au niveau individuel (observation <span class="math inline">\(k\)</span>) et au niveau du groupe (groupe <span class="math inline">\(j\)</span>), ainsi qu’une ordonnée à l’origine qui varie aléatoirement entre les groupes.</p>
<p><span class="math display">\[ y_k = \gamma_0 + \gamma_1 u_{1j[k]} + \beta_1 x_{1k} + \nu_{j[k]} + \epsilon_k \]</span></p>
<p>Dans notre exemple précédent, la valeur de <span class="math inline">\(y_k\)</span> est la somme de l’ordonnée à l’origine moyenne <span class="math inline">\(\gamma_0\)</span> (la valeur rapportée comme <code>Intercept</code> par R), des effets de prédicteurs individuels (<span class="math inline">\(x_1\)</span>: étage) et de groupe (<span class="math inline">\(u_1\)</span>: concentration d’uranium), de l’effet aléatoire de groupe <span class="math inline">\(\nu\)</span> et d’un résidu <span class="math inline">\(\epsilon\)</span>.</p>
<p>La fonction <code>fixef</code> nous donne les estimés des coefficients <span class="math inline">\(\gamma_0\)</span>, <span class="math inline">\(\gamma_1\)</span> et <span class="math inline">\(\beta_1\)</span>, tandis que <code>ranef</code> indique les estimés des effets aléatoires <span class="math inline">\(\nu_j\)</span>.</p>
<pre class="r"><code>eff_fixes &lt;- fixef(mm_radon)
eff_fixes</code></pre>
<pre><code>## (Intercept)       floor log_uranium 
##   1.4657628  -0.6682448   0.7202676</code></pre>
<pre class="r"><code>eff_alea &lt;- ranef(mm_radon)$county
head(eff_alea)</code></pre>
<pre><code>##            (Intercept)
## AITKIN    -0.020642363
## ANOKA      0.011245769
## BECKER     0.012422028
## BELTRAMI   0.111128434
## BENTON     0.008235846
## BIG STONE -0.026196357</code></pre>
<p>Plus tôt, lorsque nous avions fait une prédiction de la concentration de radon dans un sous-sol pour chaque comté, la fonction <code>predict</code> a utilisé à la fois les estimés des effets fixes et aléatoires. Autrement dit, la valeur prédite <span class="math inline">\(\hat{y}\)</span> pour un sous-sol <span class="math inline">\(x_1 = 0\)</span> du comté <span class="math inline">\(j\)</span> est donnée par:</p>
<p><span class="math display">\[ \hat{y} = \hat{\gamma_0} + \hat{\gamma_1} u_{1j} + \hat{\nu_{j}} \]</span> ,</p>
<p>où les accents circonflexes signifient que nous utilisons les valeurs estimées de chaque coefficient. Nous pourrions donc calculer manuellement les prédictions pour chaque comté de la façon suivante.</p>
<pre class="r"><code>pred_man &lt;- eff_fixes[&quot;(Intercept)&quot;] + 
    eff_fixes[&quot;log_uranium&quot;] * comtes$log_uranium + eff_alea$`(Intercept)`
                
all.equal(pred_man, comtes$mm_pred)</code></pre>
<pre><code>## [1] &quot;names for current but not for target&quot;</code></pre>
<div id="prédictions-pour-un-nouveau-groupe" class="section level2">
<h2>Prédictions pour un nouveau groupe</h2>
<p>Si on tente de prédire la concentration de radon d’un sous-sol pour un groupe (comté) non inclus dans le modèle, R génère une erreur.</p>
<pre class="r"><code>nouv_comte &lt;- data.frame(county = &quot;NOUVEAU&quot;, log_uranium = 0.5, floor = 0)
predict(mm_radon, nouv_comte)</code></pre>
<pre><code>## Error in levelfun(r, n, allow.new.levels = allow.new.levels): new levels detected in newdata</code></pre>
<p>Par défaut, la fonction <code>predict</code> appliquée au résultat de <code>lmer</code> tente d’utiliser l’ensemble des effets aléatoires. Pour effectuer une prédiction basée seulement sur les effets fixes, nous devons spécifier l’argument <code>re.form = ~0</code>.</p>
<pre class="r"><code>predict(mm_radon, nouv_comte, re.form = ~0)</code></pre>
<pre><code>##        1 
## 1.825897</code></pre>
<p>On peut vérifier que cette prédiction est basée uniquement sur les effets fixes.</p>
<pre class="r"><code>eff_fixes[&quot;(Intercept)&quot;] + eff_fixes[&quot;log_uranium&quot;] * nouv_comte$log_uranium</code></pre>
<pre><code>## (Intercept) 
##    1.825897</code></pre>
<p>Avec un modèle mixte, il est donc possible de faire des prédictions pour des groupes qui n’étaient pas dans les données originales, en utilisant la prédiction d’un groupe “moyen” (avec un effet aléatoire de groupe égal à 0). Bien sûr, l’incertitude associée à cette prédiction est plus grande que lorsqu’on prédit de nouvelles observations pour un groupe existant.</p>
<p>La fonction <code>predict</code> n’offre pas d’intervalles de confiance ou de prédiction pour des modèles mixtes. Ces intervalles peuvent être estimés en simulant des données à partir du modèle. Ces méthodes basées sur la simulation ne sont pas couvertes dans ce cours, mais font partie du cours Analyse des données complexes.</p>
</div>
</div>
<div id="effets-aléatoires-multiples" class="section level1">
<h1>Effets aléatoires multiples</h1>
<div id="exemple-croissance-dépinettes-sur-plusieurs-sites" class="section level2">
<h2>Exemple: Croissance d’épinettes sur plusieurs sites</h2>
<p>Considérons de nouveau l’exemple vu au début du dernier cours. Nous souhaitons modéliser la croissance annuelle de l’épinette blanche sur différents sites. Pour cinq années consécutives, nous avons mesuré la croissance annuelle des mêmes 100 arbres en fonction de deux prédicteurs (<span class="math inline">\(x_1, x_2\)</span>; disons le diamètre et l’âge) qui varient pour chaque observation (arbre et année). Nous connaissons aussi la valeur d’un prédicteur fixe au niveau du site (<span class="math inline">\(u_1\)</span>; par exemple la pente). Comment pourrions-nous représenter ces données avec un modèle linéaire mixte?</p>
<p>Pour choisir les effets aléatoires du modèle, nous pouvons poser la question suivante: pour quels groupes d’observations la variation de la réponse serait-elle corrélée (entre observations d’un même groupe)? Dans ce cas-ci:</p>
<ul>
<li>les observations prises sur le même arbre d’une année à l’autre;</li>
<li>les observations de deux arbres prises la même année; et</li>
<li>les observations prises sur des arbres du même site</li>
</ul>
<p>risquent d’être corrélés. Nous incluons donc trois effets aléatoires dans le modèle (arbre, site et année).</p>
<p>La valeur de <span class="math inline">\(y_k\)</span>, correspondant à la croissance de l’arbre <span class="math inline">\(i\)</span> du site <span class="math inline">\(j\)</span> lors de l’année <span class="math inline">\(t\)</span>, est représentée par le modèle:</p>
<p><span class="math display">\[ y_k = \gamma_0 + \gamma_1 u_{1j[k]} + \beta_1 x_{1k} + \beta_2 x_{2k} + \nu_{j[k]} + \xi_{i[k]} + \tau_{t[k]} + \epsilon_k \]</span></p>
<p>Dans R, si <code>pente</code> représente la pente du site et que les prédicteurs individuels sont <code>DHP</code> et <code>age</code>, ce modèle pourrait s’exprimer ainsi:</p>
<p><code>croissance ~ pente + DHP + age + (1 | site) + (1 | id_arbre) + (1 | annee)</code></p>
<p>Du point de vue de la structure d’un modèle, deux effets aléatoires peuvent être soit croisés, soit nichés.</p>
<ul>
<li><p>Les effets de l’arbre et de l’année sont croisés (<em>crossed</em>): chaque arbre est mesurée pour plusieurs années et plusieurs arbres sont mesurés chaque année. De même, les effets du site et de l’année sont croisés.</p></li>
<li><p>Les effets de l’arbre et du site sont nichés (<em>nested</em>): chaque arbre est associé à un seul site.</p></li>
</ul>
<p>Pour indiquer à R que l’effet A est niché dans l’effet B, on écrit par exemple <code>(1 | B/A)</code>. Dans ce cas-ci, la formule pourrait être ré-écrite:</p>
<p><code>croissance ~ pente + DHP + age + (1 | site / id_arbre) + (1 | annee)</code></p>
<p>Si les numéros d’identification des arbres ne sont pas répétés d’un site à l’autre, il n’est pas nécessaire de préciser les effets nichés: les deux formules sont équivalentes pour <code>lmer</code>. Cependant, si les arbres étaient numérotés 1, 2, … pour chaque site, il serait nécessaire d’utiliser la formule avec l’effet niché: dans le cas contraire, R supposerait que les arbres “1” de chaque site représenteraient le même individu.</p>
</div>
<div id="exemple-plan-dexpérience-en-parcelles-divisées" class="section level2">
<h2>Exemple: Plan d’expérience en parcelles divisées</h2>
<p>Le tableau de données <code>Oats</code> du package <em>nlme</em> présente les résultats d’une expérience agricole en parcelles divisées (<em>split-plot</em>). L’expérience est réalisée en six blocs (<code>Block</code>). Chaque bloc est divisé en trois sections où une variété différente d’avoine est semée (<code>Variety</code>), puis chaque section est divisée en quatre quadrants qui reçoivent chacun une concentration différente d’azote (<code>nitro</code>): 0, 0.2, 0.4 ou 0.6. La variable réponse est le rendement (<code>yield</code>) en avoine pour chacun des 72 quadrants (6 blocs x 3 variétés x 4 concentrations d’azote).</p>
<pre class="r"><code>library(nlme)
# Changer le bloc en facteur non-ordonné
Oats$Block &lt;- factor(Oats$Block, ordered = FALSE)
head(Oats)</code></pre>
<pre><code>## Grouped Data: yield ~ nitro | Block
##   Block     Variety nitro yield
## 1     I     Victory   0.0   111
## 2     I     Victory   0.2   130
## 3     I     Victory   0.4   157
## 4     I     Victory   0.6   174
## 5     I Golden Rain   0.0   117
## 6     I Golden Rain   0.2   114</code></pre>
<p>Voici un exemple de configuration spatiale possible pour cette expérience. Les variétés plantées (couleur) sont assignées aléatoirement aux trois sections de chaque bloc et les concentrations d’azote (nombres) sont assignés aléatoirement aux quadrants de chaque section.</p>
<p><img src="../images/split_plot.png" /></p>
<p>Le plan en parcelles divisées constitue une façon de répliquer deux traitements expérimentaux sur plusieurs blocs. Sa particularité est qu’un des traitements (ici, la variété d’avoine) est appliqué à une plus grande surface et un autre traitement (ici, la concentration d’azote) est niché dans le premier.</p>
<p>Nous pouvons d’abord définir un effet aléatoire du bloc, qui représente le fait que la variance de la réponse est plus petite entre observations du même bloc qu’entre observations de différents blocs. Cela pourrait être dû par exemple à des gradients environnementaux non-mesurés dans la parcelle.</p>
<pre class="r"><code>mm_oats &lt;- lmer(yield ~ nitro + Variety + (1 | Block), Oats)</code></pre>
<p>Pour la même raison, il est possible que la variance soit plus petite entre quadrants d’une même section; nous pouvons tenir compte de ce deuxième niveau de groupement en incluant un effet aléatoire de la section (variété) niché dans celui du bloc.</p>
<pre class="r"><code>mm_oats2 &lt;- lmer(yield ~ nitro + Variety + (1 | Block / Variety), Oats)
summary(mm_oats2)</code></pre>
<pre><code>## Linear mixed model fit by REML [&#39;lmerMod&#39;]
## Formula: yield ~ nitro + Variety + (1 | Block/Variety)
##    Data: Oats
## 
## REML criterion at convergence: 578.9
## 
## Scaled residuals: 
##      Min       1Q   Median       3Q      Max 
## -1.62948 -0.65841 -0.07207  0.55785  1.71463 
## 
## Random effects:
##  Groups        Name        Variance Std.Dev.
##  Variety:Block (Intercept) 108.9    10.44   
##  Block         (Intercept) 214.5    14.65   
##  Residual                  165.6    12.87   
## Number of obs: 72, groups:  Variety:Block, 18; Block, 6
## 
## Fixed effects:
##                   Estimate Std. Error t value
## (Intercept)         82.400      8.059  10.225
## nitro               73.667      6.781  10.863
## VarietyMarvellous    5.292      7.079   0.748
## VarietyVictory      -6.875      7.079  -0.971
## 
## Correlation of Fixed Effects:
##             (Intr) nitro  VrtyMr
## nitro       -0.252              
## VartyMrvlls -0.439  0.000       
## VarityVctry -0.439  0.000  0.500</code></pre>
<p>À première vue, il apparaît contradictoire d’utiliser la même variable <code>Variety</code> comme effet fixe et comme effet aléatoire. Toutefois, l’effet aléatoire ne s’applique pas aux différences entre les 3 variétés (il serait incorrect d’écrire <code>(1 | Variety)</code>), mais plutôt aux différences entre les 18 sections représentées par les combinaisons d’un bloc et d’une variété. C’est d’ailleurs pourquoi cet effet aléatoire est noté comme une interaction <code>Variety:Block</code> dans le sommaire.</p>
<p>En consultant les intervalles de confiance de ces deux modèles, nous remarquons que le deuxième donne un intervalle de confiance plus large pour les effets fixes des variétés, mais moins large pour l’effet de l’azote.</p>
<pre class="r"><code>confint(mm_oats, oldNames = FALSE)</code></pre>
<pre><code>## Computing profile confidence intervals ...</code></pre>
<pre><code>##                           2.5 %    97.5 %
## sd_(Intercept)|Block   8.126934 29.461033
## sigma                 12.737325 17.936286
## (Intercept)           67.144282 97.655713
## nitro                 57.976482 89.356851
## VarietyMarvellous     -3.302201 13.885535
## VarietyVictory       -15.468868  1.718868</code></pre>
<pre class="r"><code>confint(mm_oats2, oldNames = FALSE)</code></pre>
<pre><code>## Computing profile confidence intervals ...</code></pre>
<pre><code>##                                   2.5 %    97.5 %
## sd_(Intercept)|Variety:Block   4.211239 16.580608
## sd_(Intercept)|Block           5.476922 29.072388
## sigma                         10.674601 15.588813
## (Intercept)                   66.501050 98.298960
## nitro                         60.261178 87.072155
## VarietyMarvellous             -8.458427 19.041762
## VarietyVictory               -20.625094  6.875096</code></pre>
<p>Comment pouvons-nous expliquer ces différences?</p>
<ul>
<li><p>Dans le premier modèle, nous supposions que toutes les observations étaient indépendantes à l’intérieur d’un bloc. Dans le deuxième modèle, les observations d’une même section sont corrélées, donc nous n’avons pas vraiment 4 réplicats indépendants de chaque variété. Cela augmente l’incertitude sur l’effet des variétés.</p></li>
<li><p>D’un autre côté, en considérant les effets aléatoires par section, la variance résiduelle entre observations d’une même section est réduite. Puisque les 4 niveaux de concentration d’azote sont répliqués dans chaque section, une plus petite variance résiduelle contribue à réduire l’incertitude sur l’effet de ce prédicteur.</p></li>
</ul>
</div>
</div>
<div id="modèle-mixte-avec-pente-aléatoire" class="section level1">
<h1>Modèle mixte avec pente aléatoire</h1>
<p>Reprenons le jeu de données <code>rikz</code> vu au dernier cours, présentant la richesse spécifique de 45 sites intertidaux répartis sur 9 plages des Pays-Bas.</p>
<pre class="r"><code>rikz &lt;- read.csv(&quot;../donnees/rikz.csv&quot;)
# Corriger la représentation des variables catégorielles
rikz &lt;- mutate(rikz, Beach = as.factor(Beach), 
               Exposure = as.factor(Exposure))
# Transformer la réponse
rikz &lt;- mutate(rikz, srich = sqrt(Richness))
head(rikz)</code></pre>
<pre><code>##   Sample Richness Exposure    NAP Beach    srich
## 1      1       11       10  0.045     1 3.316625
## 2      2       10       10 -1.036     1 3.162278
## 3      3       13       10 -1.336     1 3.605551
## 4      4       11       10  0.616     1 3.316625
## 5      5       10       10 -0.684     1 3.162278
## 6      6        8        8  1.190     2 2.828427</code></pre>
<p>Le modèle suivant inclut un effet fixe de la position du site par rapport au niveau moyen de la mer (NAP) et une variation aléatoire de l’ordonnée à l’origine entre les plages.</p>
<pre class="r"><code>mm_rikz &lt;- lmer(srich ~ NAP + (1 | Beach), rikz)</code></pre>
<p><em>Note</em>: Pour éviter de compliquer le modèle, nous ignorons le prédicteur de groupe <code>Exposure</code> pour l’instant.</p>
<p>Nous pourrions aussi considérer un cas où l’effet du NAP sur la réponse varie d’une plage à l’autre. Notre modèle prendrait donc la forme:</p>
<p><span class="math display">\[ \hat{y_k} = \alpha_{j[k]} + \beta_{j[k]} x_k \]</span> ,</p>
<p>où l’ordonnée à l’origine et la pente de <span class="math inline">\(y\)</span> vs. <span class="math inline">\(x\)</span> varient toutes deux d’un groupe à l’autre. Dans ce cas, le modèle mixte suppose que <span class="math inline">\(\alpha_j\)</span> et <span class="math inline">\(\beta_j\)</span> suivent une distribution normale avec un écart-type de <span class="math inline">\(\sigma_\alpha\)</span> et <span class="math inline">\(\sigma_\beta\)</span>, respectivement. Toutefois, le modèle ne suppose pas que les deux effets sont indépendants. Comme nous avons vu au dernier cours, l’ordonnée à l’origine et la pente d’une régression peuvent être corrélés, donc le modèle estime aussi leur corrélation <span class="math inline">\(\rho_{\alpha \beta}\)</span>.</p>
<p>Dans R, pour représenter une variation aléatoire de l’effet d’un des prédicteurs, nous ajoutons ce prédicteur dans la partie gauche du terme d’effet aléatoire:</p>
<pre class="r"><code>mm_rikz2 &lt;- lmer(srich ~ NAP + (1 + NAP | Beach), rikz)
summary(mm_rikz2)</code></pre>
<pre><code>## Linear mixed model fit by REML [&#39;lmerMod&#39;]
## Formula: srich ~ NAP + (1 + NAP | Beach)
##    Data: rikz
## 
## REML criterion at convergence: 92.5
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -1.6245 -0.4430 -0.1095  0.3023  2.1610 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev. Corr 
##  Beach    (Intercept) 0.4389   0.6625        
##           NAP         0.1582   0.3978   -0.41
##  Residual             0.2159   0.4647        
## Number of obs: 45, groups:  Beach, 9
## 
## Fixed effects:
##             Estimate Std. Error t value
## (Intercept)   2.4369     0.2348  10.379
## NAP          -0.7026     0.1543  -4.552
## 
## Correlation of Fixed Effects:
##     (Intr)
## NAP -0.390</code></pre>
<p>Ici, la corrélation entre les effets aléatoires de l’ordonnée à l’origine et de la pente est de -0.41, tel qu’indiqué dans la colonne <code>Corr</code> du tableau des effets aléatoires. L’effet fixe du NAP représente maintenant la pente moyenne pour l’ensemble des plages.</p>
<p>Comme auparavant, les coefficients estimés par plage peuvent être consultés avec <code>coef</code>.</p>
<pre class="r"><code>coef(mm_rikz2)</code></pre>
<pre><code>## $Beach
##   (Intercept)        NAP
## 1    3.022771 -0.4129465
## 2    3.485563 -0.6702417
## 3    1.840190 -0.5388216
## 4    1.816460 -0.4861710
## 5    3.149914 -1.4983867
## 6    2.067750 -0.4565699
## 7    2.003302 -0.6094925
## 8    2.142433 -0.6761907
## 9    2.404104 -0.9748255
## 
## attr(,&quot;class&quot;)
## [1] &quot;coef.mer&quot;</code></pre>
<p>Le graphique suivant montre la variation des droites de prédiction par plage pour ce modèle. Dû à l’effet de contraction, cette variation est moins prononcée que celle du modèle estimant des effets fixes d’interaction entre le NAP et la plage (voir notes du dernier cours).</p>
<pre class="r"><code>rikz$fit2 &lt;- fitted(mm_rikz2)

ggplot(rikz, aes(x = NAP, y = srich, color = Beach)) +
    geom_point() + 
    geom_line(aes(y = fit2))</code></pre>
<p><img src="12-Modeles_mixtes_Partie2_files/figure-html/unnamed-chunk-20-1.png" width="672" /></p>
</div>
<div id="sélection-de-modèles" class="section level1">
<h1>Sélection de modèles</h1>
<p>Le processus de comparaison et sélection de modèles est plus complexe pour les modèles mixtes, car il faut choisir à la fois les termes fixes et aléatoires.</p>
<p>Par exemple, comparons l’AICc des deux modèles précédents pour la richesse spécifique en fonction du NAP dans le tableau de données <code>rikz</code>: (1) le modèle avec effets aléatoires de plage sur l’ordonnée à l’origine et (2) le modèle avec effets aléatoires sur l’ordonnée à l’origine et la pente.</p>
<pre class="r"><code>library(AICcmodavg)

aictab(list(mm_rikz = mm_rikz, mm_rikz2 = mm_rikz2))</code></pre>
<pre><code>## Warning in aictab.AIClmerMod(list(mm_rikz = mm_rikz, mm_rikz2 = mm_rikz2)): 
## Model selection for fixed effects is only appropriate with ML estimation:
## REML (default) should only be used to select random effects for a constant set of fixed effects</code></pre>
<pre><code>## 
## Model selection based on AICc:
## 
##          K   AICc Delta_AICc AICcWt Cum.Wt Res.LL
## mm_rikz  4 106.15        0.0   0.57   0.57 -48.57
## mm_rikz2 6 106.75        0.6   0.43   1.00 -46.27</code></pre>
<p>Comme nous avons vu au dernier cours, la fonction <code>lmer</code> estime les paramètres du modèle mixte par la méthode du maximum de vraisemblance restreint (REML), afin d’obtenir des estimés non-biaisés des paramètres de variance. L’avertissement indique que l’AIC(c) calculé sur des modèles ajustés par REML est seulement valide pour la comparaison de modèles avec les mêmes effets fixes, mais différents effets aléatoires.</p>
<p>Dans leur manuel, Zuur et al. (2009) suggèrent le protocole suivant:</p>
<ol style="list-style-type: decimal">
<li><p>D’abord, inclure tous les effets fixes qui nous intéressent et choisir, si nécessaire, entre différentes versions des effets aléatoires. Cette étape est basée sur l’AIC des modèles ajustés par REML.</p></li>
<li><p>Conserver les effets aléatoires choisis à l’étape précédente et comparer différentes versions des effets fixes. Cette étape requiert de comparer les modèles ajustés selon le maximum de vraisemblance, pas le REML (avec l’option <code>REML = FALSE</code> de <code>lmer</code>).</p></li>
<li><p>Réajuster le meilleur modèle par REML pour obtenir les estimés finaux.</p></li>
</ol>
<p>Ce protocole est basé sur l’idée qu’il est préférable de simplifier les effets aléatoires avant de simplifier les effets fixes, puisque c’est généralement l’estimation des effets fixes qui nous intéresse davantage.</p>
<p>Dans notre exemple, supposons que notre modèle complet du point de vue des effets fixes prend la forme <code>srich ~ NAP + Exposure</code>. Déterminons d’abord s’il faut inclure ou non l’effet aléatoire de la plage sur le coefficient NAP.</p>
<pre class="r"><code>mod_comp &lt;- lmer(srich ~ NAP + Exposure + (1 | Beach), rikz)
mod_comp2 &lt;- lmer(srich ~ NAP + Exposure + (1 + NAP | Beach), rikz)

aictab(list(mod_comp = mod_comp, mod_comp2 = mod_comp2))</code></pre>
<pre><code>## Warning in aictab.AIClmerMod(list(mod_comp = mod_comp, mod_comp2 = mod_comp2)): 
## Model selection for fixed effects is only appropriate with ML estimation:
## REML (default) should only be used to select random effects for a constant set of fixed effects</code></pre>
<pre><code>## 
## Model selection based on AICc:
## 
##           K   AICc Delta_AICc AICcWt Cum.Wt Res.LL
## mod_comp  6 100.18        0.0    0.8    0.8 -42.98
## mod_comp2 8 102.98        2.8    0.2    1.0 -41.49</code></pre>
<p>Nous choisissons donc le premier modèle (effet aléatoire sur l’ordonnée à l’origine seulement). Ensuite, comparons les modèles avec ou sans indice d’exposition. Puisque nous comparons différents effets fixes, il faut réajuster les modèles avec ML plutôt que REML.</p>
<pre class="r"><code>mod_comp_ml &lt;- lmer(srich ~ NAP + Exposure + (1 | Beach), rikz, REML = FALSE)
mod_nap_ml &lt;- lmer(srich ~ NAP + (1 | Beach), rikz, REML = FALSE)

aictab(list(mod_comp_ml = mod_comp_ml, mod_nap_ml = mod_nap_ml))</code></pre>
<pre><code>## 
## Model selection based on AICc:
## 
##             K   AICc Delta_AICc AICcWt Cum.Wt     LL
## mod_comp_ml 6  92.13        0.0   0.99   0.99 -38.96
## mod_nap_ml  4 101.83        9.7   0.01   1.00 -46.42</code></pre>
<p>En conclusion, le meilleur modèle inclut l’effet du NAP et de l’indice d’exposition, ainsi qu’un effet aléatoire de la plage sur l’ordonnée à l’origine.</p>
<div id="effet-fixe-ou-aléatoire" class="section level2">
<h2>Effet fixe ou aléatoire?</h2>
<p>Puisqu’une méthode différente est requise pour comparer les modèles avec différents effets aléatoires (REML) ou avec différents effets fixes (ML), on ne peut pas utiliser l’AIC pour déterminer si une variable devrait être considérée comme effet fixe ou aléatoire. Ex.: On ne peut pas comparer <code>srich ~ NAP + Beach</code> avec <code>srich ~ NAP + (1 | Beach)</code>.</p>
<p>Il faut donc déterminer <em>a priori</em> quelles variables constituent des effets fixes ou aléatoires. Voici quelques lignes directrices pour choisir si une variable catégorielle devrait être incluse comme effet aléatoire:</p>
<ul>
<li><p>Si le but du modèle est d’estimer l’effet d’un ou plusieurs traitements spécifiques sur la réponse, la variable représentant ces traitements devrait être un effet fixe.</p></li>
<li><p>Si la variable catégorielle a seulement deux niveaux (binaire), elle doit être considérée comme un effet fixe. Avec plus de deux niveaux, il est possible d’estimer un effet aléatoire; toutefois, plus le nombre de niveaux est petit, plus l’estimation de la variance entre groupes est incertaine, donc il y a moins d’avantages à utiliser un effet aléatoire.</p></li>
<li><p>Avec plusieurs groupes et peu d’observations dans certains de ces groupes, il est préférable d’utiliser un effet aléatoire.</p></li>
<li><p>Si on s’intéresse moins aux différences entre groupes particuliers, mais plutôt à décrire la variation entre groupes et possiblement étendre la portée du modèle à des groupes non-présents dans les données, il est préférable d’utiliser un effet aléatoire.</p></li>
</ul>
<p>Finalement, il n’y a pas de mal à inclure un effet aléatoire même si cet effet n’explique pas une grande partie de la variance. Par exemple, dans le modèle <code>srich ~ NAP + Exposure + (1 | Beach)</code>, il y avait très peu de variation entre plages une fois que l’on contrôle pour la variable <code>Exposure</code>, comme l’indiquait la corrélation intra-classe de 0.06. Le but des effets aléatoires n’est pas de détecter des différences significatives entre groupes, mais plutôt de tenir compte de la structure hiérarchique de la variation de la réponse, afin d’obtenir des meilleurs estimés des effets fixes et de leur incertitude.</p>
</div>
</div>
<div id="résumé" class="section level1">
<h1>Résumé</h1>
<ul>
<li><p>Les modèles mixtes ajustent les estimés des effets aléatoires en fonction du nombre d’observations par groupe: moins il y a d’observations par groupe, plus son effet est contracté vers la moyenne générale.</p></li>
<li><p>Pour prédire une nouvelle observation dans un groupe existant, nous utilisons l’effet aléatoire estimé pour ce groupe. Pour prédire une nouvelle observation dans un nouveau groupe, nous utilisons seulement les effets fixes (l’effet d’un groupe “moyen”).</p></li>
<li><p>Plusieurs effets aléatoires peuvent être inclus dans un même modèle. Ces effets peuvent être nichés ou croisés. Si les niveaux de la variable <span class="math inline">\(A\)</span> sont nichés dans ceux de la variable <span class="math inline">\(B\)</span>, leur effet aléatoire est représenté par <code>(1 | B/A)</code> dans la formule du modèle.</p></li>
<li><p>Une variable peut avoir un effet aléatoire sur l’ordonnée à l’origine et sur le coefficient (la pente) d’un prédicteur individuel. Cela indique que l’effet du prédicteur sur la réponse varie d’un groupe à l’autre, de façon semblable à une interaction dans un modèle linéaire classique.</p></li>
<li><p>L’AIC(c) est une mesure valide pour la comparaison de modèles avec différents effets aléatoires et les mêmes effets fixes, ou avec différents effets fixes et les mêmes effets aléatoires. Ces modèles doivent être ajustés par REML dans le premier cas et par ML (<code>REML = FALSE</code>) dans le deuxième.</p></li>
</ul>
</div>
<div id="références" class="section level1">
<h1>Références</h1>
<p>Article de synthèse sur l’application des modèles mixtes et la sélection de modèles en écologie:</p>
<ul>
<li>Harrison, X.A., Donaldson, L., Correa-Cano, M.E., Evans, J. Fisher, D.N., Goodwin, C.E.D., Robinson, B.S., Hodgson, D.J., Inger, R. (2018) A brief introduction to mixed effects modelling and multi-model inference in ecology. <em>PeerJ</em> 6: e4794.</li>
</ul>
<p>Manuels mentionnés au dernier cours:</p>
<ul>
<li><p>Gelman, A. and Hill, J. (2006) <em>Data Analysis Using Regression and Multilevel/Hierarchical Models</em>. Cambridge, Cambridge University Press.</p></li>
<li><p>Zuur, A.F., Ieno, E.N., Walker, N.J., Saveliev, A.A., Smith, G.M. (2009) <em>Mixed Effects Models and Extensions in Ecology with R</em>. New York, Springer-Verlag.</p></li>
</ul>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
