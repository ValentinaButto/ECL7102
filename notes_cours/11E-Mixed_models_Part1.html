<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />



<meta name="date" content="2018-11-19" />

<title>Linear mixed models, part 1</title>

<script src="libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="libs/bootstrap-3.3.5/css/spacelab.min.css" rel="stylesheet" />
<script src="libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="libs/navigation-1.1/tabsets.js"></script>
<link href="libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>



<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->




<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 25px;
  text-indent: 0;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>

<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Linear mixed models, part 1</h1>
<h4 class="date"><em><br/>November 19, 2018</em></h4>

</div>


<div id="objectives" class="section level1">
<h1>Objectives</h1>
<ul>
<li><p>Apply a linear mixed model to grouped data.</p></li>
<li><p>Explain how a mixed model is a compromise between a model ignoring the group effect and a model with fixed group effects.</p></li>
<li><p>Determine the situations where it is most beneficial to use a mixed model.</p></li>
</ul>
</div>
<div id="motivation" class="section level1">
<h1>Motivation</h1>
<div id="example-growth-of-several-tree-species-in-a-forest" class="section level2">
<h2>Example: Growth of several tree species in a forest</h2>
<p>Suppose you need to model tree growth in a mixed forest. You measured the following numeric variables on a sample of 100 trees of different species in a research plot:</p>
<ul>
<li>annual growth (response variable);</li>
<li>diameter (DHP);</li>
<li>age;</li>
<li>competition index (IC, based on the number and size of neighboring trees).</li>
</ul>
<p>For this exercise, you can assume that the variables have been transformed to ensure that the effect of each predictor is linear, and that the random portion of the response follows a normal distribution.</p>
<ol style="list-style-type: lower-alpha">
<li><p>What type of model would you use to represent the relationship between annual growth and the three predictors?</p></li>
<li><p>If the mean growth depends on the species, how do you include this effect in your model?</p></li>
<li><p>If the effect of the numerical predictors on growth depends on the species, how do you include this effect in your model?</p></li>
<li><p>Do the methods proposed in (b) and (c) work best with few species (e.g. 100 trees divided into 2 species) or many species (e.g. 100 trees divided into 20 species)? Do they work better if the number of trees sampled by species is similar (e.g. 5 trees for each of the 20 species) or variable (e.g. 2 to 30 trees depending on the species)?</p></li>
<li><p>Can you use this model to predict the growth of a species that is not represented in your sample of 100 trees?</p></li>
</ol>
<p>Suppose now that you know some characteristics of each species that could explain the differences between species, for example:</p>
<ul>
<li>the degree of shade tolerance (categorical variable);</li>
<li>the specific leaf area (SLA, numerical variable).</li>
</ul>
<ol style="list-style-type: lower-alpha">
<li><p>How can you include these features in your model?</p></li>
<li><p>Does the model proposed in (a) work better with few species or many species?</p></li>
<li><p>Can you use this model to predict the growth of a species that is not represented in your sample of 100 trees?</p></li>
</ol>
<p>Finally, suppose you measured growth and other individual predictors on the same 100 trees for three consecutive years.</p>
<ol style="list-style-type: lower-alpha">
<li><p>How could you add year-to-year growth variation in your model? Would it be useful to add meteorological variables of the site (e.g. mean temperature) to explain this interannual variation?</p></li>
<li><p>From a statistical point of view, does measuring the same trees each year influence the accuracy of the regression conclusions?</p></li>
</ol>
</div>
<div id="example-benthic-fauna-in-the-netherlands" class="section level2">
<h2>Example: Benthic fauna in the Netherlands</h2>
<p>The <a href="../donnees/rikz.csv">rikz.csv</a> dataset, taken from the textbook by Zuur et al. (see references at the bottom of this page), presents data on the benthic communities of 9 beaches in the Netherlands. Species richness was measured for 5 sites on each of the 9 beaches for a total of 45 observations. The <code>NAP</code> variable measures the vertical position of each site relative to mean sea level, while the exposure index (<code>Exposure</code>) is measured at the beach scale.</p>
<pre class="r"><code>rikz &lt;- read.csv(&quot;../donnees/rikz.csv&quot;)
# Correct the representation of categorical variables
rikz &lt;- mutate(rikz, Beach = as.factor(Beach), 
               Exposure = as.factor(Exposure))
head(rikz)</code></pre>
<pre><code>##   Sample Richness Exposure    NAP Beach
## 1      1       11       10  0.045     1
## 2      2       10       10 -1.036     1
## 3      3       13       10 -1.336     1
## 4      4       11       10  0.616     1
## 5      5       10       10 -0.684     1
## 6      6        8        8  1.190     2</code></pre>
<p>Since the response is a number of species, a Poisson regression might be more appropriate. However, we will not cover generalized linear mixed models in this class. Therefore, we apply a square root transformation to the response to use linear regression. This transformation generally improves the homogeneity of variance for count data.</p>
<pre class="r"><code>rikz &lt;- mutate(rikz, srich = sqrt(Richness))</code></pre>
<p>From these data, we will illustrate different strategies to account for the grouped nature of the data (9 beaches) and the group-level predictor (exposure index).</p>
<div id="model-1-ignore-groups" class="section level3">
<h3>Model 1: Ignore groups</h3>
<p>The first model includes only the site-level predictor (NAP), with an adjusted <span class="math inline">\(R^2\)</span> = 0.46. The effect of this predictor is significant and indicates that the higher sites have a lower species richness.</p>
<pre class="r"><code>mod1 &lt;- lm(srich ~ NAP, rikz)
summary(mod1)</code></pre>
<pre><code>## 
## Call:
## lm(formula = srich ~ NAP, data = rikz)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -1.1898 -0.5874 -0.1233  0.2603  2.0089 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)   2.3952     0.1241  19.295  &lt; 2e-16 ***
## NAP          -0.7409     0.1190  -6.224 1.72e-07 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.7851 on 43 degrees of freedom
## Multiple R-squared:  0.474,  Adjusted R-squared:  0.4617 
## F-statistic: 38.74 on 1 and 43 DF,  p-value: 1.724e-07</code></pre>
<p>Here is the line representing model predictions as a function of NAP.</p>
<pre class="r"><code>rikz$fit1 &lt;- fitted(mod1)

ggplot(rikz, aes(x = NAP, y = srich)) +
    geom_point() +
    geom_line(aes(y = fit1))</code></pre>
<p><img src="11E-Mixed_models_Part1_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
<p>Linear regression assumes that residuals are independent from one observation to another. This is not the case here, since the 5 sites of the same beach are more similar compared to the sites of different beaches.</p>
<pre class="r"><code>ggplot(rikz, aes(x = Beach, y = residuals(mod1))) +
    geom_point()</code></pre>
<p><img src="11E-Mixed_models_Part1_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
</div>
<div id="model-2-estimation-of-coefficients-for-each-group" class="section level3">
<h3>Model 2: Estimation of coefficients for each group</h3>
<p>By adding the <code>Beach</code> factor, this model can estimate systematic differences in species richness between beaches.</p>
<pre class="r"><code>mod2 &lt;- lm(srich ~ NAP + Beach, rikz)
summary(mod2)</code></pre>
<pre><code>## 
## Call:
## lm(formula = srich ~ NAP + Beach, data = rikz)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -1.58544 -0.28653 -0.06544  0.23657  1.69043 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  2.99457    0.26711  11.211 3.92e-13 ***
## NAP         -0.66410    0.09655  -6.878 5.49e-08 ***
## Beach2       0.61544    0.37909   1.623  0.11346    
## Beach3      -1.21158    0.37491  -3.232  0.00268 ** 
## Beach4      -1.13596    0.38510  -2.950  0.00564 ** 
## Beach5      -0.32863    0.38648  -0.850  0.40093    
## Beach6      -0.90219    0.37835  -2.385  0.02265 *  
## Beach7      -0.98741    0.39419  -2.505  0.01705 *  
## Beach8      -0.89080    0.38392  -2.320  0.02628 *  
## Beach9      -0.79350    0.38561  -2.058  0.04712 *  
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.5882 on 35 degrees of freedom
## Multiple R-squared:  0.7596, Adjusted R-squared:  0.6978 
## F-statistic: 12.29 on 9 and 35 DF,  p-value: 1.744e-08</code></pre>
<p>This model amounts to estimating a different intercept for each group: the <code>Intercept</code> is the mean of <code>srich</code> for Beach 1 when <code>NAP = 0</code> (at mean sea level), the value of <code>Beach2</code> is the difference in means between beaches 2 and 1, etc.</p>
<p>The adjusted <span class="math inline">\(R^2\)</span> increased to 0.70 for this model. Here are its prediction lines superimposed to the data.</p>
<pre class="r"><code>rikz$fit2 &lt;- fitted(mod2)

ggplot(rikz, aes(x = NAP, y = srich, color = Beach)) +
    geom_point() +
    geom_line(aes(y = fit2))</code></pre>
<p><img src="11E-Mixed_models_Part1_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
<p>A more flexible model would allow the effect of the NAP (the slope of the line) to vary from one beach to another, by adding the interaction between <code>NAP</code> and <code>Beach</code>.</p>
<pre class="r"><code>mod2_inter &lt;- lm(srich ~ NAP * Beach, rikz)
summary(mod2_inter)</code></pre>
<pre><code>## 
## Call:
## lm(formula = srich ~ NAP * Beach, data = rikz)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -0.84831 -0.16080 -0.03091  0.14909  0.98737 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  3.28835    0.24259  13.555 1.45e-13 ***
## NAP         -0.05077    0.28172  -0.180 0.858319    
## Beach2       0.30239    0.32158   0.940 0.355394    
## Beach3      -1.50542    0.31542  -4.773 5.61e-05 ***
## Beach4      -1.56073    0.33715  -4.629 8.25e-05 ***
## Beach5       0.11078    0.35432   0.313 0.756947    
## Beach6      -1.25466    0.31812  -3.944 0.000513 ***
## Beach7      -1.39537    0.41116  -3.394 0.002144 ** 
## Beach8      -1.17907    0.32697  -3.606 0.001242 ** 
## Beach9      -0.85912    0.33879  -2.536 0.017314 *  
## NAP:Beach2  -0.54313    0.36261  -1.498 0.145780    
## NAP:Beach3  -0.47943    0.37104  -1.292 0.207267    
## NAP:Beach4  -0.37552    0.35511  -1.057 0.299666    
## NAP:Beach5  -1.82561    0.38805  -4.705 6.74e-05 ***
## NAP:Beach6  -0.36229    0.33258  -1.089 0.285636    
## NAP:Beach7  -0.48212    0.41379  -1.165 0.254155    
## NAP:Beach8  -0.62429    0.32975  -1.893 0.069089 .  
## NAP:Beach9  -1.01278    0.35527  -2.851 0.008256 ** 
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.4508 on 27 degrees of freedom
## Multiple R-squared:  0.8911, Adjusted R-squared:  0.8225 
## F-statistic:    13 on 17 and 27 DF,  p-value: 7.079e-09</code></pre>
<p>The adjusted <span class="math inline">\(R^2\)</span> increased to 0.82, but this model has 17 adjustable parameters for only 45 observations. According to the AICc, the model without interaction is the best compromise between complexity and good fit.</p>
<pre class="r"><code>library(AICcmodavg)
aictab(list(mod1 = mod1, mod2 = mod2, mod2_inter = mod2_inter))</code></pre>
<pre><code>## 
## Model selection based on AICc:
## 
##             K   AICc Delta_AICc AICcWt Cum.Wt     LL
## mod2       11  98.64       0.00    0.8    0.8 -34.32
## mod2_inter 19 101.41       2.77    0.2    1.0 -16.50
## mod1        3 110.47      11.82    0.0    1.0 -51.94</code></pre>
<p>Here are the prediction lines of the model with interaction. This model is almost equivalent to performing a separate linear regression for each group, except that the residual variance must be the same for all groups. Each line is estimated from only 5 observations, so it is likely that the model exaggerates the differences between beaches (overfitting).</p>
<pre class="r"><code>rikz$fit2i &lt;- fitted(mod2_inter)

ggplot(rikz, aes(x = NAP, y = srich, color = Beach)) +
    geom_point() +
    geom_line(aes(y = fit2i))</code></pre>
<p><img src="11E-Mixed_models_Part1_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
</div>
<div id="model-3-group-level-predictor" class="section level3">
<h3>Model 3: Group-level predictor</h3>
<p>Rather than estimating mean species richness and/or the relationship between richness and NAP separately for each beach (as in the previous model), we could instead try to explain these differences based on predictors measured at the beach level.</p>
<p>The following model assumes that the (transformed) richness is a function of the interaction between NAP (defined by site) and the exposure index defined by beach.</p>
<pre class="r"><code>mod3 &lt;- lm(srich ~ NAP * Exposure, rikz)
summary(mod3)</code></pre>
<pre><code>## 
## Call:
## lm(formula = srich ~ NAP * Exposure, data = rikz)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -1.01561 -0.26022 -0.07632  0.18031  1.62592 
## 
## Coefficients:
##                Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)      3.5907     0.2641  13.597  &lt; 2e-16 ***
## NAP             -0.5939     0.2856  -2.079  0.04420 *  
## Exposure10      -1.0101     0.2950  -3.424  0.00146 ** 
## Exposure11      -1.7375     0.2976  -5.839 8.68e-07 ***
## NAP:Exposure10  -0.3680     0.3113  -1.182  0.24429    
## NAP:Exposure11   0.1281     0.3140   0.408  0.68549    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.5639 on 39 degrees of freedom
## Multiple R-squared:  0.7538, Adjusted R-squared:  0.7223 
## F-statistic: 23.88 on 5 and 39 DF,  p-value: 6.417e-11</code></pre>
<p>Note that it is not enough to check the coefficients to see if the interaction is significant, rather we must look at the ANOVA table.</p>
<pre class="r"><code>anova(mod3)</code></pre>
<pre><code>## Analysis of Variance Table
## 
## Response: srich
##              Df  Sum Sq Mean Sq F value    Pr(&gt;F)    
## NAP           1 23.8787 23.8787 75.0869 1.255e-10 ***
## Exposure      2 11.6166  5.8083 18.2643 2.527e-06 ***
## NAP:Exposure  2  2.4831  1.2416  3.9041   0.02848 *  
## Residuals    39 12.4026  0.3180                      
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p>Here, the interaction is significant even if the model’s coefficients for <code>NAP: Exposure10</code> and <code>NAP: Exposure11</code> are not. These coefficients only indicate the difference between the slopes of <em>srich</em> vs. <em>NAP</em> for exposure levels 10 vs. 8 (in the first case) or 11 vs. 8 (in the second case). It is possible that the most significant difference is between 10 and 11, as suggested by the prediction lines.</p>
<pre class="r"><code>rikz$fit3 &lt;- fitted(mod3)

ggplot(rikz, aes(x = NAP, y = srich, color = Exposure)) +
    geom_point() +
    geom_line(aes(y = fit3))</code></pre>
<p><img src="11E-Mixed_models_Part1_files/figure-html/unnamed-chunk-13-1.png" width="672" /></p>
<p>Compared to the previous model, this approach is not only more parsimonious (fewer parameters to fit), but it also allows us to explain the differences between beaches according to environmental parameters. We could therefore apply the predictions of the model to other beaches as long as we know their exposure index.</p>
<p>In this case, it appears that the exposure index accounts for much of the variation between groups. However, how could we include differences that remain between groups after controlling for the effect of this index?</p>
<p>In a classical linear regression context, it is not possible to include both a categorical variable indicating the group and a group-level predictor. In the following example, since the mean differences in richness between beaches (after controlling for the effect of the NAP) are fully taken into account by the <code>Beach</code> factor, there is no variation left for the <code>Exposure</code> variable to explain.</p>
<pre class="r"><code>mod_exp_beach &lt;- lm(srich ~ NAP + Beach + Exposure, rikz)
summary(mod_exp_beach)</code></pre>
<pre><code>## 
## Call:
## lm(formula = srich ~ NAP + Beach + Exposure, data = rikz)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -1.58544 -0.28653 -0.06544  0.23657  1.69043 
## 
## Coefficients: (2 not defined because of singularities)
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  2.99457    0.26711  11.211 3.92e-13 ***
## NAP         -0.66410    0.09655  -6.878 5.49e-08 ***
## Beach2       0.61544    0.37909   1.623  0.11346    
## Beach3      -1.21158    0.37491  -3.232  0.00268 ** 
## Beach4      -1.13596    0.38510  -2.950  0.00564 ** 
## Beach5      -0.32863    0.38648  -0.850  0.40093    
## Beach6      -0.90219    0.37835  -2.385  0.02265 *  
## Beach7      -0.98741    0.39419  -2.505  0.01705 *  
## Beach8      -0.89080    0.38392  -2.320  0.02628 *  
## Beach9      -0.79350    0.38561  -2.058  0.04712 *  
## Exposure10        NA         NA      NA       NA    
## Exposure11        NA         NA      NA       NA    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.5882 on 35 degrees of freedom
## Multiple R-squared:  0.7596, Adjusted R-squared:  0.6978 
## F-statistic: 12.29 on 9 and 35 DF,  p-value: 1.744e-08</code></pre>
<p>Thus, we obtain <code>NA</code> values for the coefficients related to the exposure index. Note that the output of this model is identical to that of <code>mod2</code>. If we had written the formula with Exposure before Beach, the model would estimate the effects of the two coefficients of the exposure index, but in return, two of the beach effects would become <code>NA</code>. In terms of predictions, it would be the same model.</p>
<p>An identical problem arises if one tries to model a variation of the slope of <code>srich ~ NAP</code> according to both the exposure index and the beach. That model would be equivalent to <code>mod2_inter</code> above.</p>
<pre class="r"><code>mod_exp_beach &lt;- lm(srich ~ NAP * Exposure + NAP * Beach , rikz)
all.equal(fitted(mod_exp_beach), fitted(mod2_inter)) </code></pre>
<pre><code>## [1] TRUE</code></pre>
</div>
<div id="model-4-two-step-linear-model" class="section level3">
<h3>Model 4: Two-step linear model</h3>
<p>To solve the problem mentioned at the end of the previous section, we could first estimate the richness differences between beaches from the site-level data, and then model the beach effects according to the exposure index.</p>
<p>For the first step, we use model 2 above (intercept varies by beach), except that we add <code>- 1</code> to the model formula to force the intercept to be zero. This trick allows us to obtain coefficients for each beach that correspond to the intercept for that beach, rather than a difference measured from a reference level. Note that this trick only works for the first categorical variable in a regression.</p>
<pre class="r"><code>mod4_1 &lt;- lm(srich ~ NAP + Beach - 1, rikz)
summary(mod4_1)</code></pre>
<pre><code>## 
## Call:
## lm(formula = srich ~ NAP + Beach - 1, data = rikz)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -1.58544 -0.28653 -0.06544  0.23657  1.69043 
## 
## Coefficients:
##        Estimate Std. Error t value Pr(&gt;|t|)    
## NAP    -0.66410    0.09655  -6.878 5.49e-08 ***
## Beach1  2.99457    0.26711  11.211 3.92e-13 ***
## Beach2  3.61000    0.26440  13.653 1.39e-15 ***
## Beach3  1.78298    0.26307   6.778 7.41e-08 ***
## Beach4  1.85861    0.26839   6.925 4.78e-08 ***
## Beach5  2.66594    0.26948   9.893 1.12e-11 ***
## Beach6  2.09238    0.26404   7.924 2.55e-09 ***
## Beach7  2.00715    0.27616   7.268 1.73e-08 ***
## Beach8  2.10377    0.26751   7.864 3.04e-09 ***
## Beach9  2.20106    0.26879   8.189 1.20e-09 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.5882 on 35 degrees of freedom
## Multiple R-squared:  0.9527, Adjusted R-squared:  0.9392 
## F-statistic: 70.48 on 10 and 35 DF,  p-value: &lt; 2.2e-16</code></pre>
<p>We then create a second dataset containing only the beaches and their exposure index. We use the <code>distinct</code> function of <em>dplyr</em>, which extracts the unique combinations the specified variables from a data frame.</p>
<pre class="r"><code>rikz_beach &lt;- distinct(rikz, Beach, Exposure)
rikz_beach</code></pre>
<pre><code>##   Exposure Beach
## 1       10     1
## 2        8     2
## 3       11     3
## 4       11     4
## 5       10     5
## 6       11     6
## 7       11     7
## 8       10     8
## 9       10     9</code></pre>
<p>We then add to this data frame the beach intercepts obtained at step 1, which is the response we want to model at step 2.</p>
<pre class="r"><code>rikz_beach$coef &lt;- coef(mod4_1)[-1] # Coefficient 1 is NAP

mod4_2 &lt;- lm(coef ~ Exposure, rikz_beach)
summary(mod4_2)</code></pre>
<pre><code>## 
## Call:
## lm(formula = coef ~ Exposure, data = rikz_beach)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -0.3876 -0.1523  0.0000  0.1571  0.5032 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)   3.6100     0.3101  11.640 2.42e-05 ***
## Exposure10   -1.1187     0.3467  -3.226  0.01800 *  
## Exposure11   -1.6747     0.3467  -4.830  0.00291 ** 
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.3101 on 6 degrees of freedom
## Multiple R-squared:  0.803,  Adjusted R-squared:  0.7373 
## F-statistic: 12.23 on 2 and 6 DF,  p-value: 0.007645</code></pre>
<p>One problem with this approach is that each beach is considered a single point at the second step. If the number of samples differed from one beach to another, this model would under-represent the better-sampled beaches. For this case, each beach has the same number of points and the estimated coefficients for the exposure index are very close to those obtained by model 3.</p>
</div>
</div>
</div>
<div id="mixed-linear-models" class="section level1">
<h1>Mixed linear models</h1>
<p><strong>Mixed models</strong> are conceptually similar to the two-step regression performed above, except that both steps are performed simultaneously to account for the uncertainty of the group effects. This type of model is particularly useful when one or more of the following conditions apply:</p>
<ul>
<li><p>the data are grouped or have a hierarchical structure at two or more levels (e.g.: plots grouped by sites grouped by region);</p></li>
<li><p>the explanatory variables are also defined at several levels;</p></li>
<li><p>the number of groups is too large, or the number of observations in some groups is too small, to estimate a separate effect for each group;</p></li>
<li><p>there is more interest in variation between groups than in the effect of particular groups;</p></li>
<li><p>we want to apply the model to new groups not represented in the data.</p></li>
</ul>
<div id="mathematical-representation-of-a-linear-mixed-model" class="section level2">
<h2>Mathematical representation of a linear mixed model</h2>
<p>A <strong>linear mixed model</strong> is a linear regression where one or more of the coefficients vary from one group of observations to another, <em>and where this variation is modeled by a statistical distribution</em>. They are also known as <em>hierarchical</em> or <em>multilevel</em> models because they model the variation at least at two levels (individual and group of observations).</p>
<p>We will start by dealing with mixed models where only the intercept varies by group. For that type of model, the mean value of the response for observation <span class="math inline">\(k\)</span> (<span class="math inline">\(\hat{y_k}\)</span>) is the linear combination of the predictors <span class="math inline">\(x_1\)</span>, <span class="math inline">\(x_2\)</span>, and so on, to which we add an intercept specific to the group <span class="math inline">\(j\)</span> containing observation <span class="math inline">\(k\)</span>: <span class="math inline">\(\alpha_{j[k]}\)</span>. (We use <span class="math inline">\(\alpha\)</span> rather than <span class="math inline">\(\beta_0\)</span> for the intercept to simplify the notation a bit.)</p>
<p><span class="math display">\[ \hat{y_k} = \alpha_{j[k]} + \beta_1 x_{1k} + \beta_2 x_{2k} + ...\]</span></p>
<p>Just like in the linear regression model, the observed <span class="math inline">\(y_k\)</span> follows a normal distribution around its mean. The suffix <span class="math inline">\(y\)</span> has been added to <span class="math inline">\(\sigma\)</span> to specify that it is the standard deviation of the <span class="math inline">\(y\)</span>.</p>
<p><span class="math display">\[ y_k \sim N(\hat{y_k}, \sigma_y) \]</span></p>
<p>So far, this model is identical to a linear regression with a categorical variable, if <span class="math inline">\(\alpha_j\)</span> was the intercept for category <span class="math inline">\(j\)</span>. The particular feature of mixed models is that the <span class="math inline">\(\alpha_j\)</span> are random values from a normal distribution with a mean <span class="math inline">\(\mu_\alpha\)</span> and a standard deviation <span class="math inline">\(\sigma_\alpha\)</span>. In other words, the observed groups are part of a “population” of possible groups and we wish to estimate the mean and the variance of <span class="math inline">\(\alpha\)</span> in that population.</p>
<p><span class="math display">\[ \alpha_{j} \sim N(\mu_\alpha, \sigma_\alpha) \]</span></p>
<p>The group effect <span class="math inline">\(\alpha_j\)</span> is called a <em>random</em> effect, as opposed to <em>fixed</em> effects that are independently estimated without originating from a common distribution (for example, the <span class="math inline">\(m - 1\)</span> coefficients of a factor of <span class="math inline">\(m\)</span> categories in a classical linear regression). This model is called <em>mixed</em> because it contains both fixed effects (the <span class="math inline">\(\beta\)</span> associated with predictors <span class="math inline">\(x_1\)</span>, <span class="math inline">\(x_2\)</span>, etc.) and random effects.</p>
<p>There is no particular reason for choosing a normal distribution for <span class="math inline">\(\alpha_j\)</span>. However, if all that is known of a variable is its mean and its standard deviation, the normal distribution is in some sense the most likely, that is, the one that brings the least additional assumptions.</p>
</div>
<div id="linear-mixed-model-with-r" class="section level2">
<h2>Linear mixed model with R</h2>
<p>In this example, we will fit a mixed model of the type shown above to the same data in <code>rikz</code>. The model includes the <code>NAP</code> predictor and an intercept that varies by beach.</p>
<p>To estimate the parameters of a mixed model, we use the <code>lmer</code> function of the <em>lme4</em> package. The formula for a mixed model resembles those seen before, except for the last term: <code>(1 | Beach)</code>. This term means that the intercept (referred to as <code>1</code>) varies between the levels of the <code>Beach</code> factor.</p>
<pre class="r"><code>library(lme4)

mmod &lt;- lmer(srich ~ NAP + (1 | Beach), rikz)
summary(mmod)</code></pre>
<pre><code>## Linear mixed model fit by REML [&#39;lmerMod&#39;]
## Formula: srich ~ NAP + (1 | Beach)
##    Data: rikz
## 
## REML criterion at convergence: 97.1
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -2.5693 -0.4286 -0.1869  0.3230  2.9399 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev.
##  Beach    (Intercept) 0.2957   0.5438  
##  Residual             0.3460   0.5882  
## Number of obs: 45, groups:  Beach, 9
## 
## Fixed effects:
##             Estimate Std. Error t value
## (Intercept)  2.37424    0.20405  11.635
## NAP         -0.68063    0.09501  -7.163
## 
## Correlation of Fixed Effects:
##     (Intr)
## NAP -0.162</code></pre>
<p>Let’s look at the different components of this result. The first line indicates that the model has been fit with the restricted maximum likelihood (REML) method. Without going into too much detail, the maximum likelihood produces a bias when estimating variances (random effects), and the REML serves to correct that bias.</p>
<p>The random effects block contains the estimates for the variance and standard deviation of the intercept (<span class="math inline">\(\sigma_\alpha\)</span>), as well as the residual variance and standard deviation (<span class="math inline">\(\sigma_y\)</span>). The fixed effects block shows the estimate for the mean intercept (<span class="math inline">\(\mu_\alpha\)</span>) and the effect of the NAP. The summary also indicates the estimated correlation between the two fixed effects. A negative correlation is to be expected when the mean value of the predictor is greater than zero: if the line is rotated around the mean so as to increase the slope, the position of the intercept moves down the <span class="math inline">\(y\)</span> axis (see diagram below).</p>
<p><img src="11E-Mixed_models_Part1_files/figure-html/unnamed-chunk-20-1.png" width="288" /></p>
<p>Note that <code>lmer</code> does not provide a <span class="math inline">\(p\)</span>-value for the estimated effects, because unlike the case of a linear model, the exact distribution of these estimates is not known. We can nevertheless obtain approximate confidence intervals with <code>confint</code>.</p>
<pre class="r"><code>confint(mmod)</code></pre>
<pre><code>## Computing profile confidence intervals ...</code></pre>
<pre><code>##                  2.5 %     97.5 %
## .sig01       0.2664346  0.9469885
## .sigma       0.4682062  0.7455375
## (Intercept)  1.9537581  2.7916024
## NAP         -0.8729868 -0.4948024</code></pre>
<p>The effect of the NAP is therefore significant with a threshold of <span class="math inline">\(\alpha = 0.05\)</span>. In this table, <code>.sig01</code> is <span class="math inline">\(\sigma_\alpha\)</span> and <code>.sigma</code> is <span class="math inline">\(\sigma_y\)</span>. Standard deviations must be positive. A value less than or equal to zero for a standard deviation or its confidence interval indicates that the model is incorrectly specified.</p>
<p>We can separately extract the fixed and random effects of the model with the <code>fixef</code> and<code>ranef</code> functions.</p>
<pre class="r"><code>fixef(mmod)</code></pre>
<pre><code>## (Intercept)         NAP 
##   2.3742423  -0.6806307</code></pre>
<pre class="r"><code>ranef(mmod)</code></pre>
<pre><code>## $Beach
##   (Intercept)
## 1   0.4962684
## 2   1.0050818
## 3  -0.4791252
## 4  -0.4104708
## 5   0.2444787
## 6  -0.2252788
## 7  -0.2858167
## 8  -0.2124511
## 9  -0.1326862</code></pre>
<p>The random effects are the estimates of the difference between the intercept of each beach (1 to 9) and their mean given by <code>(Intercept)</code>. The estimated intercept for beach 1 is 2.37 + 0.50 = 2.87 and so on. Instead of calculating these values for each beach, we can get them with the <code>coef</code> function.</p>
<pre class="r"><code>coef(mmod)</code></pre>
<pre><code>## $Beach
##   (Intercept)        NAP
## 1    2.870511 -0.6806307
## 2    3.379324 -0.6806307
## 3    1.895117 -0.6806307
## 4    1.963772 -0.6806307
## 5    2.618721 -0.6806307
## 6    2.148964 -0.6806307
## 7    2.088426 -0.6806307
## 8    2.161791 -0.6806307
## 9    2.241556 -0.6806307
## 
## attr(,&quot;class&quot;)
## [1] &quot;coef.mer&quot;</code></pre>
<p>The result of this function gives us the coefficients of the linear regression by group. Our model does not include random effects on the coefficient of <code>NAP</code>, so it is constant for all groups.</p>
<p>What is the difference between these estimated effects for each beach and those of a classical linear model where the <code>Beach</code> categorical variable was specified as a fixed effect? Let’s compare the prediction lines of the mixed model (solid lines) with those of model 2 seen above (<code>lm(srich ~ NAP + Beach)</code>, dotted lines). We also add the line corresponding to model 1 which ignores the differences between beaches (dashed black line).</p>
<pre class="r"><code>rikz$fitmm &lt;- fitted(mmod)

ggplot(rikz, aes(x = NAP, y = srich, color = Beach)) +
    geom_point() + 
    geom_line(aes(y = fit1), color = &quot;black&quot;, linetype = &quot;dashed&quot;) +
    geom_line(aes(y = fit2), linetype = &quot;dotted&quot;) +
    geom_line(aes(y = fitmm))</code></pre>
<p><img src="11E-Mixed_models_Part1_files/figure-html/unnamed-chunk-24-1.png" width="672" /></p>
<p>Predictions of the mixed model for each beach are shifted towards the overall mean. This effect is more pronounced as one moves away from the mean (see for example beach 2 at the top of the graph). In statistics, this is called a <em>shrinkage</em> of the group effects.</p>
</div>
<div id="mixed-models-as-a-compromise-between-underfitting-and-overfitting" class="section level2">
<h2>Mixed models as a compromise between underfitting and overfitting</h2>
<p>What is happening here? Assuming that the effects of each beach come from a common distribution, the mixed model estimates the intercept of each beach by taking into account not only the values measured at that beach, but also those of the other beaches. It is therefore a compromise between underfitting (e.g. model 1, which totally ignores differences between beaches) and overfitting (e.g. model 2, which independently estimates the mean intercept for each beach based on its 5 sites).</p>
<p>In other words, the differences between the mean values measured by group can be due either to real differences in the response between the groups, or to random sampling. The ANOVA we saw earlier in this semester would ask whether these differences between groups of observations are too large to be due to chance. The mixed model attempts instead to estimate the portion of observed differences that is due to a real group effect and the portion that is due to random sampling in each group.</p>
</div>
<div id="diagnostic-plots" class="section level2">
<h2>Diagnostic plots</h2>
<p>The <code>plot</code> function applied to a mixed model output only produces on graph, that of residuals vs. fitted values.</p>
<pre class="r"><code>plot(mmod)</code></pre>
<p><img src="11E-Mixed_models_Part1_files/figure-html/unnamed-chunk-25-1.png" width="672" /></p>
<p>To reproduce the quantile-quantile plot of residuals, we can call the <code>qqnorm</code> and<code>qqline</code> functions. This graph shows that the most extreme residuals are further from the mean than those predicted by the normal distribution.</p>
<pre class="r"><code>qqnorm(residuals(mmod))
qqline(residuals(mmod))</code></pre>
<p><img src="11E-Mixed_models_Part1_files/figure-html/unnamed-chunk-26-1.png" width="672" /></p>
<p>In a mixed model, group effects are also assumed to follow a normal distribution. We test this assumption with a quantile-quantile plot of random effects (<code>ranef</code>).</p>
<pre class="r"><code>beach_coef &lt;- ranef(mmod)$Beach
qqnorm(beach_coef$`(Intercept)`)
qqline(beach_coef$`(Intercept)`)</code></pre>
<p><img src="11E-Mixed_models_Part1_files/figure-html/unnamed-chunk-27-1.png" width="672" /></p>
<p>Even with just 9 points, it is obvious that differences between beaches are not normally distributed.</p>
<p>Note that the influence measures of observations such as Cook distance do not apply to mixed models.</p>
</div>
</div>
<div id="mixed-model-with-group-related-predictor" class="section level1">
<h1>Mixed model with group-related predictor</h1>
<p>At the end of the previous section, we saw that the differences between each beach and the overall mean do not follow a normal distribution. Could some of that variation be explained by the exposure index measured at the beach level?</p>
<p>To include the effect of a group-level predictor, we need to modify the model from the previous section. The group-level intercept was defined by a normal distribution:</p>
<p><span class="math display">\[ \alpha_{j} \sim N(\mu_\alpha, \sigma_\alpha) \]</span></p>
<p>In this case, <span class="math inline">\(\mu_\alpha\)</span> is not a constant, but varies linearly with the predictor <span class="math inline">\(u_1\)</span>.</p>
<p><span class="math display">\[ \mu_\alpha = \gamma_0 + \gamma_1 u_1 \]</span></p>
<p>It is therefore a two-level regression model, where <span class="math inline">\(u_1\)</span> is a group-level predictor and <span class="math inline">\(\gamma_1\)</span> is the coefficient of that predictor. From a conceptual point of view, it is useful to differentiate group-level and individual-level predictors. However, we could also rewrite the model to separate the fixed effects (at both levels) and the random effects (which have a mean of 0), for example:</p>
<p><span class="math display">\[ y_k = \gamma_0 + \gamma_1 u_{1j[k]} + \beta_1 x_{1k} + \beta_2 x_{2k} + \nu_{j[k]} + \epsilon_k \]</span></p>
<p>In this representation, the value <span class="math inline">\(y_k\)</span> of observation <span class="math inline">\(k\)</span> depends on the intercept <span class="math inline">\(\gamma_0\)</span>, a group-level predictor <span class="math inline">\(u_1\)</span>, two individual-level predictors (<span class="math inline">\(x_1\)</span>, <span class="math inline">\(x_2\)</span>). The last two terms respectively represent the random variation for group <span class="math inline">\(j\)</span> and observation <span class="math inline">\(k\)</span>:</p>
<p><span class="math display">\[ \nu_j \sim N(0, \sigma_\alpha) \]</span> <span class="math display">\[ \epsilon_k \sim N(0, \sigma_y) \]</span></p>
<p>We can think of <span class="math inline">\(\nu_j\)</span> as the part of the residual that is shared by all the observations of group <span class="math inline">\(j\)</span>, while <span class="math inline">\(\epsilon\)</span> is an independent residual from one observation to another. To fit this model in R, we simply add the predictor to the formula in <code>lmer</code>. The estimate works without the need to explicitly tell R that the value of this variable is the same for all observations in a group.</p>
<pre class="r"><code>mmod_exp &lt;- lmer(srich ~ NAP + Exposure + (1 | Beach), rikz)
summary(mmod_exp)</code></pre>
<pre><code>## Linear mixed model fit by REML [&#39;lmerMod&#39;]
## Formula: srich ~ NAP + Exposure + (1 | Beach)
##    Data: rikz
## 
## REML criterion at convergence: 86
## 
## Scaled residuals: 
##      Min       1Q   Median       3Q      Max 
## -2.38707 -0.48281 -0.07465  0.47962  3.03495 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev.
##  Beach    (Intercept) 0.02315  0.1521  
##  Residual             0.34658  0.5887  
## Number of obs: 45, groups:  Beach, 9
## 
## Fixed effects:
##             Estimate Std. Error t value
## (Intercept)  3.62081    0.30510  11.867
## NAP         -0.70349    0.09107  -7.724
## Exposure10  -1.11766    0.33998  -3.287
## Exposure11  -1.66923    0.34021  -4.907
## 
## Correlation of Fixed Effects:
##            (Intr) NAP    Exps10
## NAP        -0.082              
## Exposure10 -0.891 -0.007       
## Exposure11 -0.888 -0.037  0.800</code></pre>
<p>Some notes on this result:</p>
<ul>
<li><p>The estimate of <span class="math inline">\(\sigma_\alpha\)</span> (0.15) has decreased compared to its value in the previous model (0.54), showing that the predictor explains a good amount of the variation observed between the groups. The standard deviation of individual observations (0.59) has not changed, which is expected because a group-level predictor cannot explain the differences between observations of the same group.</p></li>
<li><p>Correlations between the fixed effects (Intercept), Exposure10, and Exposure11 are to be expected. With the default contrasts in R, <code>(Intercept)</code> is the intercept for the reference level of the variable (Exposure = 8), <code>Exposure10</code> is the difference between levels 10 and 8, and <code>Exposure11</code> is the difference between levels 11 and 8. So, if the estimate of the mean for level 8 increases, the two differences (10 - 8 and 11 - 8) decrease.</p></li>
</ul>
<p>Note that after taking into account the effect of the exposure index, the random group effects are closer to a normal distribution.</p>
<pre class="r"><code>beach_coef &lt;- ranef(mmod_exp)$`Beach`
qqnorm(beach_coef$`(Intercept)`)
qqline(beach_coef$`(Intercept)`)</code></pre>
<p><img src="11E-Mixed_models_Part1_files/figure-html/unnamed-chunk-29-1.png" width="672" /></p>
</div>
<div id="intra-class-correlation" class="section level1">
<h1>Intra-class correlation</h1>
<p>In the mixed models presented above, <span class="math inline">\(\sigma_\alpha\)</span> represents the standard deviation of the mean response between groups while <span class="math inline">\(\sigma_y\)</span> represents the standard deviation of the response between observations of the same group.</p>
<p>The <em>intra-class correlation</em> is defined as the ratio:</p>
<p><span class="math display">\[ \frac{\sigma_\alpha^2}{\sigma_\alpha^2 + \sigma_y^2} \]</span></p>
<p>This ratio approaches 0 if <span class="math inline">\(\sigma_y \gg \sigma_\alpha\)</span> (the variation between groups is negligible compared to the variation between individuals of the same group) and approaches 1 if <span class="math inline">\(\sigma_\alpha \gg \sigma_y\)</span> (almost all the variation is due to differences between groups).</p>
<p>The intra-class correlation is about 0.45 for the first model (<code>mmod</code>) and decreases to 0.06 taking into account the exposure index (model <code>mmod_exp</code>).</p>
<p>From a practical point of view, the intra-class correlation indicates which scale contributes more to the variation of the response, so at which scale we could sample more to reduce the uncertainty of the model. In our example, if this correlation was close to 1, it would be better to sample multiple beaches with few samples per beach; if not, we could get a larger sample over a limited number of beaches. Of course, this assumes that the beaches observed so far are representative of the “population” of beaches that interest us.</p>
</div>
<div id="mixed-models-for-unbalanced-groups" class="section level1">
<h1>Mixed models for unbalanced groups</h1>
<p>In the previous example, the number of observations was balanced between the groups (9 groups of 5 observations). Mixed models also have interesting properties for cases where groups do not contain the same number of observations, as we will see in the next example.</p>
<div id="example-house-radon-concentration-in-minnesota" class="section level2">
<h2>Example: House radon concentration in Minnesota</h2>
<p>The dataset <a href="../donnees/radon.csv">radon.csv</a>, from the textbook by Gelman and Hill, contains radon concentration measurements (<code>log_radon</code>, on a logarithmic scale) from 919 houses in 85 counties (<code>county</code>) of the American state of Minnesota. The number of houses sampled per county ranges from 1 to 116. This dataset includes a house-level predictor, the floor where the measurement was taken (with 0 = basement and 1 = ground floor), and a county-level predictor, the soil uranium level (also on a logarithmic scale).</p>
<pre class="r"><code>radon &lt;- read.csv(&quot;../donnees/radon.csv&quot;)
head(radon)</code></pre>
<pre><code>##   county floor log_uranium log_radon
## 1 AITKIN     1  -0.6890476 0.7884574
## 2 AITKIN     0  -0.6890476 0.7884574
## 3 AITKIN     0  -0.6890476 1.0647107
## 4 AITKIN     0  -0.6890476 0.0000000
## 5  ANOKA     0  -0.8473129 1.1314021
## 6  ANOKA     0  -0.8473129 0.9162907</code></pre>
<p>We estimate the parameters of a mixed model with fixed effects of the floor and uranium level, as well as a random variation of the intercept by county.</p>
<pre class="r"><code>mm_radon &lt;- lmer(log_radon ~ floor + log_uranium + (1 | county), radon)
summary(mm_radon)</code></pre>
<pre><code>## Linear mixed model fit by REML [&#39;lmerMod&#39;]
## Formula: log_radon ~ floor + log_uranium + (1 | county)
##    Data: radon
## 
## REML criterion at convergence: 2134.2
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -4.9673 -0.6117  0.0274  0.6555  3.3848 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev.
##  county   (Intercept) 0.02446  0.1564  
##  Residual             0.57523  0.7584  
## Number of obs: 919, groups:  county, 85
## 
## Fixed effects:
##             Estimate Std. Error t value
## (Intercept)  1.46576    0.03794  38.633
## floor       -0.66824    0.06880  -9.713
## log_uranium  0.72027    0.09176   7.849
## 
## Correlation of Fixed Effects:
##             (Intr) floor 
## floor       -0.357       
## log_uranium  0.145 -0.009</code></pre>
<p>How can fixed effects be interpreted in this model?</p>
<ul>
<li><code>(Intercept)</code> is the mean of <code>log_radon</code> if <code>floor</code> = 0 (i.e. in a basement) and <code>log_uranium</code> = 0.</li>
<li><code>floor</code> is the difference of <code>log_radon</code> if <code>floor</code> increases by 1 (i.e. ground floor compared to the basement).</li>
<li><code>log_uranium</code> is the effect of an increase of one unit of <code>log_uranium</code> on <code>log_radon</code>. In the particular case where the two variables are on a logarithmic scale, this coefficient can be interpreted as a multiplicative effect: a 1% increase in the concentration of uranium in the soil increases the concentration of radon in homes by 0.72%.</li>
</ul>
<p>Now let’s use the model to predict <code>log_radon</code> for a basement in each county. First, we extract the county name, the uranium concentration and the number of houses per county (that number will be useful later).</p>
<pre class="r"><code>comtes &lt;- group_by(radon, county, log_uranium) %&gt;%
    summarize(n = n()) %&gt;%
    ungroup()</code></pre>
<p>Here is the graph of county-level predicted values:</p>
<pre class="r"><code>comtes$floor &lt;- 0 # basement
comtes$mm_pred &lt;- predict(mm_radon, comtes)

ggplot(comtes, aes(x = log_uranium, y = mm_pred)) +
    geom_point()</code></pre>
<p><img src="11E-Mixed_models_Part1_files/figure-html/unnamed-chunk-33-1.png" width="672" /></p>
<p>These predictions deviate from the mean linear trend based on the estimated intercepts for each county (random effects).</p>
<p>Let’s now compare these predictions to those of two classical linear regressions, one with no county effect or one with fixed effects for each county.</p>
<pre class="r"><code>lm_radon1 &lt;- lm(log_radon ~ floor + log_uranium, radon)
lm_radon2 &lt;- lm(log_radon ~ floor + log_uranium + county, radon)

comtes &lt;- mutate(comtes, pred1 = predict(lm_radon1, comtes), 
                 pred2 = predict(lm_radon2, comtes))

ggplot(comtes, aes(x = log_uranium)) +
    labs(y = &quot;log_radon&quot;) +
    geom_line(aes(y = pred1)) +
    geom_point(aes(y = pred2), shape = 1) +
    geom_point(aes(y = mm_pred))</code></pre>
<p><img src="11E-Mixed_models_Part1_files/figure-html/unnamed-chunk-34-1.png" width="672" /></p>
<p>The line represents the prediction of the model ignorning the county, the filled points indicate the county effects of the mixed model, and the hollow points indicate the fixed effects by county. The predictions of the mixed model are closer to the mean trend, showing the shrinkage of the coefficients for the mixed model.</p>
<p>Now let’s look at the effect of the <span class="math inline">\(n\)</span>, the sample size in each county. For clarity, the two predictions of the same county are connected by a dotted line.</p>
<pre class="r"><code>ggplot(comtes, aes(x = log_uranium)) +
    labs(y = &quot;log_radon&quot;) +
    geom_line(aes(y = pred1)) +
    geom_point(aes(y = pred2, size = n), shape = 1) +
    geom_point(aes(y = mm_pred, size = n)) +
    geom_segment(aes(xend = log_uranium, y = mm_pred, yend = pred2),
                 linetype = &quot;dotted&quot;)</code></pre>
<p><img src="11E-Mixed_models_Part1_files/figure-html/unnamed-chunk-35-1.png" width="672" /></p>
<p>This result shows that the smaller the sample size in a county, the more its effect is shrunk towards the mean. In other words, the fewer points in a county, the more the deviation observed between that county and the overall trend is likely to be due to random sampling, and the more the mixed model must “correct” this value by bringing it closer to that of the general trend.</p>
</div>
</div>
<div id="summary" class="section level1">
<h1>Summary</h1>
<ul>
<li><p>A linear mixed model (also called a multilevel model) is an extension of linear regression for grouped data, where some of the coefficients vary randomly from one group to another.</p></li>
<li><p>In this class, we have seen examples where intercept includes a random effect. In the next class, we’ll see how to add random effects to other coefficients.</p></li>
<li><p>A mixed model is a compromise between a linear regression that ignores the group structure and a regression that estimates a separate fixed effect for each group.</p></li>
<li><p>To do this, the mixed model corrects the estimation of the effects of each group to bring them closer to the general trend (shrinkage). The smaller the sample in a group, the larger this correction is. For this reason, mixed models are particularly useful when there are a large number of groups and few observations in some groups.</p></li>
<li><p>In classical linear regression, one cannot include both a fixed effect per group and a group-level predictor. A mixed model can include both the random effect of groups and an explanatory variable defined at the group level.</p></li>
</ul>
</div>
<div id="references" class="section level1">
<h1>References</h1>
<p>Here are two great textbooks to consult for more details on mixed or multi-level models.</p>
<ul>
<li><p>Gelman, A. and Hill, J. (2006) <em>Data Analysis Using Regression and Multilevel/Hierarchical Models</em>. Cambridge, Cambridge University Press.</p></li>
<li><p>Zuur, A.F., Ieno, E.N., Walker, N.J., Saveliev, A.A., Smith, G.M. (2009) <em>Mixed Effects Models and Extensions in Ecology with R</em>. New York, Springer-Verlag.</p></li>
</ul>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
