---
title: "Modèles mixtes"
date: "21 novembre 2018"
output: 
    html_document:
        self_contained: false
        lib_dir: libs
        theme: spacelab
        toc: true
        toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```


## 1. Effet de l'azote sur le rendement de variétés d'avoine

Le tableau de données `Oats` inclus dans le package *nlme* présente les résultats d'une expérience agricole en parcelles divisées (*split-plot*). L'expérience est réalisée en six blocs (`Block`). Chaque bloc est divisé en trois sections où une variété différente d'avoine est semée (`Variety`), puis chaque section est divisée en quatre quadrants qui reçoivent chacun une concentration différente d'azote (`nitro`): 0, 0.2, 0.4 ou 0.6. La variable réponse est le rendement (`yield`) en avoine pour chacun des 72 quadrants (6 blocs x 3 variétés x 4 concentrations d'azote).

```{r}
library(nlme)
data(Oats)
# Changer le bloc en facteur non-ordonné
Oats$Block <- factor(Oats$Block, ordered = FALSE)
str(Oats)
```

(a) Pour les facteurs `Block` et `Variety`, quel type de contrastes devriez-vous utiliser pour comparer l'effet de chaque catégorie à la moyenne, plutôt qu'à une catégorie de référence? Spécifiez ce type de contrastes et nommez les variables de contraste pour en faciliter l'interprétation.

**Réponse**

```{r}

contrasts(Oats$Block) <- "contr.sum"
# Ajout de noms aux contrastes (correspondant aux N - 1 premiers niveaux)
colnames(contrasts(Oats$Block)) <- levels(Oats$Block)[-6]

contrasts(Oats$Variety) <- "contr.sum"
colnames(contrasts(Oats$Variety)) <- levels(Oats$Variety)[-3]
```


(b) Estimez les paramètres d'un modèle linéaire du rendement en fonction de la concentration d'azote, de la variété d'avoine et d'un effet *fixe* du bloc. Vérifiez s'il est utile d'inclure l'interaction entre l'azote et la variété. Que signifierait une telle interaction?

**Réponse**

Une interaction signifierait que l'effet de l'azote sur le rendement varie d'une variété à l'autre.

Pour vérifier si l'interaction est significative entre une variable catégorielle et une variable numérique, nous pouvons consulter le tableau d'ANOVA du modèle avec l'interaction. Celui-ci montre que l'interaction n'est pas significative.

```{r}
mod1b_inter <- lm(yield ~ nitro * Variety + Block, Oats)
anova(mod1b_inter)
```

Nous aurions aussi pu comparer l'AICc du modèle avec et sans interaction, qui confirme que le modèle sans interaction est préférable.

```{r}
mod1b <- lm(yield ~ nitro + Variety + Block, Oats)

library(AICcmodavg)
aictab(list(sans_inter = mod1b, avec_inter = mod1b_inter))
```


(c) Choisissez le modèle avec ou sans interaction selon votre résultat en (b), vérifiez les graphiques de diagnostic et interprétez la valeur des coefficients.

**Réponse**

```{r, eval = FALSE}
plot(mod1b) # Modèle sans interaction
```

```{r, echo = FALSE}
par(mfrow = c(2, 2))
plot(mod1b)
par(mfrow = c(1, 1))
```

Il n'y a pas de tendance marquée pour les résidus. Le diagramme quantile-quantile montre que les observations ont un peu *moins* de valeurs extrêmes qu'une distribution normale (car les quantiles des résidus aux deux extrémités sont plus près de 0 que les quantiles théoriques).

```{r}
summary(mod1b)
```

- L'ordonnée à l'origine est le rendement moyen à une concentration d'azote de 0.
- Le rendement augmente d'environ 74 par unité de concentration d'azote. *Note*: Puisque la concentration varie entre 0 et 0.6, il serait plus utile de diviser cette valeur, ex.: le rendement augmente de 7.4 par augmentation de 0.1 unités d'azote.
- Les variétés *Golden Rain* et *Marvellous* ont un rendement supérieur de 0.5 et 5.8 à la moyenne, respectivement. La troisième variété (*Victory*) a un rendement inférieur de 6.3 à la moyenne (-(0.5 + 5.8)). 
- De même, les coefficients des blocs donnent la différence de rendement moyen entre ce bloc et la moyenne générale. Le dernier bloc (BlockI) a un rendement supérieur de 31.4 à la moyenne (la somme des six différences doit être 0 pour `contr.sum`).


(d) Estimez maintenant les paramètres d'un modèle mixte identique au modèle linéaire en (c), excepté que l'effet des blocs est aléatoire plutôt que fixe. Comparez les effets fixes communs aux deux modèles, ainsi que les effets fixes de bloc du modèle précédent aux effets aléatoires par bloc de ce nouveau modèle. Expliquez les différences que vous observez, s'il y a lieu.

**Réponse**

Les fonctions `fixef` et `ranef` permettent d'obtenir les effets fixes et aléatoires du modèle mixte.

```{r}
library(lme4)
mod1d <- lmer(yield ~ nitro + Variety + (1 | Block), Oats)

fixef(mod1d)
ranef(mod1d)
```

Les effets fixes (ordonnée à l'origine, azote et variétés) sont les mêmes pour les deux modèles. 

- *Note*: Ici, on a un plan d'expérience complètement équilibré, avec les mêmes combinaisons de variétés et de concentrations d'azote dans chaque bloc. Si ce n'était pas le cas, on ne s'attendrait pas à ce que les effets estimés pour l'azote et la variété soient les mêmes dans les deux versions du modèle.

Les effets aléatoires de bloc sont moins extrêmes que les effets fixes du modèle précédent (ex.: -7.2 au lieu de -7.7 pour le bloc VI, 29.0 plutôt que 31.4 pour le bloc I). Cela est conforme avec l'idée que le modèle mixte contracte les effets aléatoires.


(e) Calculez la corrélation intra-classe pour le modèle mixte en (d). Quelle est la signification mathématique de ce coefficient? Comment interprétez-vous de résultat d'un point de vue biologique?

**Réponse**

La corrélation intra-classe est obtenue en divisant la variance des effets aléatoires de groupe (blocs) par la somme de la variance de groupe et la variance résiduelle. Ces valeurs apparaissent dans le résultat sommaire du modèle.

```{r}
summary(mod1d)
```

```{r}
cic <- 245 / (234.7 + 245) 
cic
```

Ce coefficient signifie qu'après avoir tenu compte des effets fixes (variété et azote), la variation entre les blocs compte pour 51% de la variation restante, l'autre 49% étant la variation entre observations d'un même bloc. D'un point de vue biologique, cela signifie que les facteurs aléatoires à grande échelle (bloc) et à petite échelle (quadrant) ont une influence environ égale sur le rendement observé.


## 2. Indicateurs d'une maladie chez les abeilles

La loque américaine est une maladie infectieuse affectant les colonies d'abeille. Le tableau de données [bees.csv](bees.csv), tiré du manuel de Zuur et al. *Mixed Effects Models and Extensions in Ecology with R*, contient des mesures de la densité de spores bactériennes (`Spobee`) relevée sur 72 abeilles provenant de 24 ruches (`Hive`, 3 abeilles par ruche). 

Nous voulons déterminer la relation entre cette densité de spores et deux variables définies par ruche: le niveau d'infection observé dans la ruche (`Infection`) et un estimé de la taille de la colonie (`BeesN`).

```{r}
bees <- read.csv("bees.csv")
str(bees)
```

(a) Avant de modéliser ces données, effectuez les transformations suivantes.

- Le niveau d'infection est sur une échelle qualitative (0 = pas de symptômes, 1 = infection légere, 2 = modérée et 3 = sévère). Puisque nous avons très peu de ruches pour les différents niveaux d'infection (1 de niveau 1, 1 de niveau 2 et 2 de niveau 3), créez une nouvelle variable binaire `pres_inf` qui indique la présence (niveaux 1 à 3) ou l'absence (niveau 0) d'infection. 

- La distribution de la réponse `Spobee` est très asymétrique. Tel que suggéré par Zuur et al., créez une nouvelle variable en appliquant la fonction `log1p`, équivalente à *log(Spobee + 1)*. Il s'agit d'une transformation logarithmique où on a préalabement ajouté 1 à la réponse, afin d'éviter de prendre le logarithme de 0.

- Exprimez la taille de la colonie en unités de 10 000 abeilles.

**Réponse**

```{r}
library(dplyr)

bees <- mutate(bees, logspore = log1p(Spobee),
               pres_inf = Infection > 0, Bees_10k = BeesN / 10000)
```


(b) Estimez les paramètres d'un modèle mixte pour déterminer l'effet de la présence d'infection et de la taille de la colonie sur la densité de spores (transformée) observée sur les abeilles. Quel effet aléatoire serait approprié pour ce problème?

**Réponse**

Puisque les observations sont groupées par ruche, il faut utiliser `Hive` comme effet aléatoire. 

```{r}
mod2b <- lmer(logspore ~ pres_inf + Bees_10k + (1 | Hive), bees)
summary(mod2b)
```


(c) Utilisez des graphiques de diagnostic pour vérifier les suppositions du modèle, incluant la normalité des effets aléatoires.

**Réponse**

Le graphique des résidus vs. valeurs prédites indique un problème possible au niveau de l'homogénéité de la variance: la variance des résidus diminue pour les valeurs prédites plus élevées.

```{r}
plot(mod2b)
```

Le diagramme quantile-quantile des résidus montre une assez bonne normalité (excepté deux valeurs extrêmes en bas).

```{r}
qqnorm(residuals(mod2b))
qqline(residuals(mod2b))
```

Le diagramme quantile-quantile des effets aléatoires semble dévier de la normalité: les points suivent une courbe, indiquant une distribution asymétrique.

```{r}
effets_alea <- ranef(mod2b)$Hive$`(Intercept)`
qqnorm(effets_alea)
qqline(effets_alea)
```

L'asymétrie est plus évidente sur un histogramme des effets aléatoires.

```{r}
hist(effets_alea)
```


(d) Quel est le coefficient de corrélation intra-classe de ce modèle? Pour estimer plus précisément les effets fixes de ce modèle, serait-il préférable d'échantillonner plus de ruches, ou plus d'abeilles par ruche?

**Réponse**

D'après les résultats sommaires du modèle en (b), la variance de groupe est de 4.82 et la variance résiduelle est de 0.60, pour une coefficient de 0.89.

```{r}
cic <- 4.82 / (4.82 + 0.60)
cic
```

Vu que 89% de la variation aléatoire est présente entre les ruches et seulement 11% entre les individus d'une même ruche, il serait plus utile d'échantilloner davantage de ruches.


(e) Quels sont les intervalles de confiance à 95% des effets fixes dans le modèle mixte? Si on remplaçait ce modèle par une régression linéaire ignorant complètement la variable `Hive`, ces intervalles seraient-ils plus étroits ou plus larges, et pourquoi?

**Réponse**

La fonction `confint` estime les intervalles de confiance. 

```{r}
confint(mod2b)
```

Voici le modèle linéaire sans effet de ruche.

```{r}
mod2f <- lm(logspore ~ pres_inf + Bees_10k, bees)
confint(mod2f)
```

Ces intervalles de confiance sont moins large que ceux du modèle mixte. En particulier, la variable `Bees_10k` est significative ici, mais ne l'était pas dans le modèle mixte.

Le modèle linéaire suppose que les 72 observations sont indépendantes et calcule les intervalles de confiance d'après cette supposition. Toutefois, nous avons 3 observations dans chacune des 24 ruches et ces trois observations sont très corrélées, comme le montre le résultat en (e). Dans ce cas, le modèle linéaire surestime la précision des estimés.
