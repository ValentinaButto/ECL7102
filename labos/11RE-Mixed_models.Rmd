---
title: "Mixed models"
date: "November 21, 2018"
output: 
    html_document:
        self_contained: false
        lib_dir: libs
        theme: spacelab
        toc: true
        toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```


## 1. Effect of nitrogen on the yield of oat varieties

The `Oats` data frame included in the *nlme* package shows the results of a split-plot agricultural experiment. The experiment is done in six blocks (`Block`). Each block is divided into three sections where a different variety of oats is sown (`Variety`), then each section is divided into four quadrants, each receiving a different concentration of nitrogen (`nitro`): 0, 0.2, 0.4 or 0.6. The response variable is the oat yield of each of the 72 quadrants (6 blocks x 3 varieties x 4 nitrogen concentrations).

```{r}
library(nlme)
data(Oats)
# Changer le bloc en facteur non-ordonn√©
Oats$Block <- factor(Oats$Block, ordered = FALSE)
str(Oats)
```

(a) For the `Block` and` Variety` factors, which kind of contrasts should you use to compare the effect of each category to the mean, rather than to a reference category? Specify this type of contrast and name the contrast variables to facilitate the interpretation.

**Answer**

```{r}

contrasts(Oats$Block) <- "contr.sum"
# Adding names to contrasts (matching the first N-1 levels)
colnames(contrasts(Oats$Block)) <- levels(Oats$Block)[-6]

contrasts(Oats$Variety) <- "contr.sum"
colnames(contrasts(Oats$Variety)) <- levels(Oats$Variety)[-3]
```


(b) Estimate the parameters of a linear model of yield as a function of nitrogen concentration, oat variety and a *fixed* effect of the block. Check if it is useful to include the interaction between nitrogen and variety. What would such an interaction mean?

**Answer**

An interaction would mean that the effect of nitrogen on yield varies from variety to variety.

To check if the interaction is significant between a categorical variable and a numeric variable, we can look at the ANOVA table of the model with the interaction. This shows that the interaction is not significant.

```{r}
mod1b_inter <- lm(yield ~ nitro * Variety + Block, Oats)
anova(mod1b_inter)
```

We could also have compared the AICc for the models with and without interaction, confirming that the no interaction model is preferrable.

```{r}
mod1b <- lm(yield ~ nitro + Variety + Block, Oats)

library(AICcmodavg)
aictab(list(sans_inter = mod1b, avec_inter = mod1b_inter))
```


(c) Choose the model with or without interaction according to your result in (b), check the diagnostic graphs and interpret the value of the coefficients.

**Answer**

```{r, eval = FALSE}
plot(mod1b) # Model without interaction
```

```{r, echo = FALSE}
par(mfrow = c(2, 2))
plot(mod1b)
par(mfrow = c(1, 1))
```

There is no marked trend for residuals. The quantile-quantile plot shows that the observations have a little *less* extreme values than a normal distribution (because the quantiles of the residuals at both ends are closer to 0 than the theoretical quantiles).

```{r}
summary(mod1b)
```

- The intercept is the average yield at a nitrogen concentration of 0.
- The yield increases by about 74 per unit increase in nitrogen concentration. *Note*: Since the concentration varies between 0 and 0.6, it would be more useful to divide this value, e.g. the yield increases by 7.4 for each 0.1 units of nitrogen.
- *Golden Rain* and *Marvelous* varieties are 0.5 and 5.8 above average, respectively. The third variety (*Victory*) has a yield 6.3 lower than the average (- (0.5 + 5.8)).
- Similarly, the coefficients of the blocks give the mean yield difference between that block and the overall mean. The last block (BlockI) has a yield 31.4 higher than the mean (the sum of the six differences must be 0 for `contr.sum`).


(d) Now estimate the parameters of a mixed model identical to the linear model in (c), except that the effect of the blocks is random rather than fixed. Compare the fixed effects common to both models, as well as the block fixed effects of the previous model to the random effects of this new model. Explain the differences you observe, if any.

**Answer**

The `fixef` and `ranef` functions give us the fixed and random effects of the mixed model.

```{r}
library(lme4)
mod1d <- lmer(yield ~ nitro + Variety + (1 | Block), Oats)

fixef(mod1d)
ranef(mod1d)
```

The fixed effects (intercept, nitrogen, and varieties) are the same for both models.

- *Note*: Here, we have a completely balanced design, with the same combinations of varieties and nitrogen concentrations in each block. If this were not the case, we would not expect the estimated effects for nitrogen and variety to be the same in both versions of the model.

The random block effects are less extreme than the fixed effects of the previous model (e.g. -7.2 instead of -7.7 for block VI, 29.0 rather than 31.4 for block I). This is consistent with the idea that the mixed model shrinks random effects.


(e) Calculate the intra-class correlation for the mixed model in (d). What is the mathematical significance of this coefficient? How do you interpret the result from a biological point of view?

**Answer**

The intra-class correlation is obtained by dividing the variance of the group random effects (blocks) by the sum of the group variance and the residual variance. These values appear in the summary result of the model.

```{r}
summary(mod1d)
```

```{r}
cic <- 245 / (234.7 + 245) 
cic
```

This coefficient means that after taking into account the fixed effects (variety and nitrogen), the variation between the blocks accounts for 51% of the remaining variance, the other 49% being the variation between observations of the same block. From a biological point of view, this means that large-scale (block) and small-scale (quadrant) random factors have about equal influence on observed yield.


## 2. Indicators of disease in bees

American foulbrood is an infectious disease affecting bee colonies. The [bees.csv](bees.csv) dataset, from the Zuur et al. textbook *Mixed Effects Models and Extensions in Ecology with R*, contains measurements of bacterial spore density (`Spobee`) found on 72 bees from 24 hives (`Hive`, 3 bees per hive).

We want to determine the relationship between this density of spores and two variables defined for each hive: the level of infection observed in the hive (`Infection`) and an estimate of the size of the colony (`BeesN`).

```{r}
bees <- read.csv("bees.csv")
str(bees)
```

(a) Before modeling these data, perform the following transformations.

- The level of infection is on a qualitative scale (0 = no symptoms, 1 = mild infection, 2 = moderate and 3 = severe). Since we have very few hives for the different levels of infection (1 level 1, 1 level 2, and 2 level 3), create a new `pres_inf` binary variable that indicates presence (levels 1 to 3) or absence (level 0) of infection.

- The distribution of the `Spobee` response is very asymmetrical. As suggested by Zuur et al., create a new variable by applying the `log1p` function, equivalent to *log(Spobee + 1)*. This is a logarithmic transformation where 1 has been added to the response beforehand to avoid taking the logarithm of 0.

- Express the size of the colony in units of 10,000 bees.

**Answer**

```{r}
library(dplyr)

bees <- mutate(bees, logspore = log1p(Spobee),
               pres_inf = Infection > 0, Bees_10k = BeesN / 10000)
```


(b) Estimate the parameters of a mixed model to determine the effect of presence of infection and colony size on the (transformed) spore density observed on bees. Which random effect would be appropriate for this problem?

**Answer**

Since observations are grouped by hive, we use `Hive` as the random effect.

```{r}
mod2b <- lmer(logspore ~ pres_inf + Bees_10k + (1 | Hive), bees)
summary(mod2b)
```


(c) Use diagnostic graphs to verify model assumptions, including the normality of random effects.

**Answer**

The graph of residuals vs. fitted values indicates a possible problem with homogeneity of variance: the variance of the residuals decreases for the higher predicted values.

```{r}
plot(mod2b)
```

The quantile-quantile plot of the residuals shows a fairly good normality (except for two extreme values at the bottom).

```{r}
qqnorm(residuals(mod2b))
qqline(residuals(mod2b))
```

The quantile-quantile plot of the random effects seems to deviate from normality: the points follow a curve, indicating an asymmetric distribution.

```{r}
effets_alea <- ranef(mod2b)$Hive$`(Intercept)`
qqnorm(effets_alea)
qqline(effets_alea)
```

The asymmetry is more evident in a histogram of the random effects.

```{r}
hist(effets_alea)
```


(d) What is the intra-class correlation coefficient of this model? To more accurately estimate the fixed effects of this model, would it be better to sample more hives, or more bees per hive?

**Answer**

According to the summary results of the model in (b), the group variance is 4.82 and the residual variance is 0.60, for a coefficient of 0.89.

```{r}
cic <- 4.82 / (4.82 + 0.60)
cic
```

Since 89% of the random variation is present between hives and only 11% between individuals in the same hive, it would be more useful to sample more hives.


(e) What are the 95% confidence intervals for fixed effects in the mixed model? If we replace this model with a linear regression completely ignoring the `Hive` variable, would these intervals be narrower or wider, and why?

**Answer**

The `confint` function estimates confidence intervals.

```{r}
confint(mod2b)
```

Here is the linear regression without hive effects.

```{r}
mod2f <- lm(logspore ~ pres_inf + Bees_10k, bees)
confint(mod2f)
```

These confidence intervals are more narrow than those of the mixed model. In particular, the variable `Bees_10k` is significant here, but was not in the mixed model.

The linear regression assumes that the 72 observations are independent and calculates the confidence intervals according to this assumption. However, we have 3 observations in each of the 24 hives and these three observations are highly correlated, as shown by the result in (e). In this case, the linear model overestimates the precision of the estimates.

